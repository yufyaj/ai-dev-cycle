name: Auto Test

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issueç•ªå·'
        required: true
        type: string
      branch_name:
        description: 'ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "Claude AI Agent"
          git config user.email "claude-agent@anthropic.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          pip install PyGithub requests pytest pytest-cov

          # Node.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
          if [ -f package.json ]; then
            npm ci
          fi

      - name: Update issue status
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ§ª **ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­**

          å®Ÿè¡Œé …ç›®:
          - âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
          - âœ… çµ±åˆãƒ†ã‚¹ãƒˆ
          - âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
          - âœ… æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ã®ãƒ†ã‚¹ãƒˆ"

      - name: Run all tests
        id: run-tests
        continue-on-error: true
        run: |
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™..."
          python3 scripts/run_all_tests.py

          # ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèª
          if [ $? -eq 0 ]; then
            echo "test_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸ"
          else
            echo "test_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.event.inputs.issue_number }}
          path: |
            **/test-results/
            **/coverage/
            **/htmlcov/
            **/.coverage
          retention-days: 7

      - name: Fix test failures with Claude
        if: steps.run-tests.outputs.test_passed == 'false'
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          echo "ğŸ”§ ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚’è‡ªå‹•ä¿®æ­£ä¸­..."

          python3 << 'EOF'
          import os
          import json
          import subprocess
          from anthropic import Anthropic

          # ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å–å¾—
          test_log = subprocess.run(['cat', 'out/test_results.log'],
                                   capture_output=True, text=True).stdout

          # Claude APIã§ä¿®æ­£ã‚’è©¦ã¿ã‚‹
          client = Anthropic(api_key=os.environ['CLAUDE_CODE_OAUTH_TOKEN'])

          prompt = f"""
          ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„:

          {test_log}

          CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã„ã€ä»¥ä¸‹ã‚’å®Ÿæ–½:
          1. ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®š
          2. ä¿®æ­£ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
          3. TDDåŸå‰‡ã«åŸºã¥ãä¿®æ­£

          ä¿®æ­£å†…å®¹ã‚’JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„:
          {{
            "files_to_fix": [
              {{"path": "file_path", "content": "fixed_content"}}
            ],
            "explanation": "ä¿®æ­£ã®èª¬æ˜"
          }}
          """

          # ã“ã“ã§Claude APIã‚’å‘¼ã³å‡ºã—ã¦ä¿®æ­£ã‚’å–å¾—
          # å®Ÿè£…ã¯ç°¡ç•¥åŒ–

          print("ä¿®æ­£ã‚’é©ç”¨ä¸­...")
          EOF

          # ä¿®æ­£ã‚’å†åº¦ã‚³ãƒŸãƒƒãƒˆ
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "fix: ãƒ†ã‚¹ãƒˆå¤±æ•—ã®è‡ªå‹•ä¿®æ­£

            ğŸ¤– AI ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆä¿®æ­£
            Issue #${ISSUE_NUMBER}

            Co-authored-by: Claude AI <claude-agent@anthropic.com>"
            git push
          fi

      - name: Retry tests after fix
        if: steps.run-tests.outputs.test_passed == 'false'
        id: retry-tests
        run: |
          echo "ğŸ”„ ãƒ†ã‚¹ãƒˆã‚’å†å®Ÿè¡Œã—ã¾ã™..."
          python3 scripts/run_all_tests.py

          if [ $? -eq 0 ]; then
            echo "retry_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… ä¿®æ­£å¾Œã®ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸ"
          else
            echo "retry_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ ä¿®æ­£å¾Œã‚‚ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi

      - name: Generate test report
        if: always()
        run: |
          mkdir -p out/reports
          python3 << 'EOF'
          import json
          import os

          # ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
          report = {
            "issue_number": os.environ.get('ISSUE_NUMBER'),
            "branch": os.environ.get('BRANCH_NAME'),
            "initial_test": os.environ.get('test_passed', 'false'),
            "retry_test": os.environ.get('retry_passed', 'N/A'),
            "timestamp": os.popen('date -Iseconds').read().strip()
          }

          with open('out/reports/test_report.json', 'w') as f:
            json.dump(report, f, indent=2)

          print("ğŸ“Š ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
          EOF
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
          BRANCH_NAME: ${{ github.event.inputs.branch_name }}
          test_passed: ${{ steps.run-tests.outputs.test_passed }}
          retry_passed: ${{ steps.retry-tests.outputs.retry_passed }}

      - name: Trigger review workflow
        if: steps.run-tests.outputs.test_passed == 'true' || steps.retry-tests.outputs.retry_passed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = '${{ github.event.inputs.issue_number }}';
            const branchName = '${{ github.event.inputs.branch_name }}';

            console.log(`ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™...`);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-review.yml',
              ref: 'main',
              inputs: {
                issue_number: issueNumber,
                branch_name: branchName
              }
            });

            console.log(`âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ`);

      - name: Update issue with test results
        if: always()
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          if [ "${{ steps.run-tests.outputs.test_passed }}" == "true" ] || [ "${{ steps.retry-tests.outputs.retry_passed }}" == "true" ]; then
            gh issue comment "${ISSUE_NUMBER}" --body "âœ… **ãƒ†ã‚¹ãƒˆå®Œäº†**

            ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸï¼
            - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: âœ…
            - çµ±åˆãƒ†ã‚¹ãƒˆ: âœ…
            - ã‚«ãƒãƒ¬ãƒƒã‚¸: âœ…

            æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼"
          else
            gh issue comment "${ISSUE_NUMBER}" --body "âš ï¸ **ãƒ†ã‚¹ãƒˆã«å•é¡ŒãŒã‚ã‚Šã¾ã™**

            è‡ªå‹•ä¿®æ­£ã‚’è©¦ã¿ã¾ã—ãŸãŒã€ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã¾ã™ã€‚
            è©³ç´°ã¯ [ãƒ†ã‚¹ãƒˆãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            äººé–“ã®ä»‹å…¥ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"

            gh issue edit "${ISSUE_NUMBER}" --add-label "ai:test-failed"
          fi