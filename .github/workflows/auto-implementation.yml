name: Auto Implementation

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'å®Ÿè£…ã™ã‚‹Issueç•ªå·'
        required: true
        type: string

jobs:
  implement:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®dispatchæ¨©é™

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "Claude AI Agent"
          git config user.email "claude-agent@anthropic.com"

      - name: Get Issue details
        id: issue-details
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          # Issueæƒ…å ±ã‚’å–å¾—ã—ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          gh issue view "${ISSUE_NUMBER}" --json number,title,body,labels > issue.json

          # Issueæƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          TITLE=$(jq -r '.title' issue.json)
          BODY=$(jq -r '.body // ""' issue.json)
          echo "title=${TITLE}" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ Issue #${ISSUE_NUMBER}: ${TITLE}"

      - name: Create implementation branch
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          BRANCH_NAME="ai/cp-${ISSUE_NUMBER}"

          # main ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚’å–å¾—
          git checkout main
          git pull origin main

          # æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Œã°å‰Šé™¤
          git branch -D "${BRANCH_NAME}" 2>/dev/null || true
          git push origin --delete "${BRANCH_NAME}" 2>/dev/null || true

          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b "${BRANCH_NAME}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_ENV

          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒä½œæˆå®Œäº†: ${BRANCH_NAME}"

      - name: Update issue status
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ¤– **å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã—ãŸ**

          ãƒ–ãƒ©ãƒ³ãƒ: \`${{ env.branch_name }}\`

          å‡¦ç†ä¸­:
          - ğŸ“ Issue ã®è§£æ
          - ğŸ’» ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
          - ğŸ§ª ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆTDDï¼‰"

      - name: Claude Implementation
        uses: anthropics/claude-code-action@beta
        with:
          # OAuth tokenä½¿ç”¨ï¼ˆMAXå¥‘ç´„ï¼‰
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # agentãƒ¢ãƒ¼ãƒ‰ï¼ˆworkflow_dispatchå¯¾å¿œï¼‰
          mode: 'agent'

          # direct_promptã§è‡ªå‹•å®Ÿè£…ï¼ˆ@claudeä¸è¦ï¼‰
          direct_prompt: |
            Issue #${{ github.event.inputs.issue_number }} ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

            ã‚¿ã‚¤ãƒˆãƒ«: ${{ steps.issue-details.outputs.title }}

            å†…å®¹:
            ${{ steps.issue-details.outputs.body }}

            ä»¥ä¸‹ã®è¦ä»¶ã‚’å®ˆã£ã¦ãã ã•ã„ï¼š
            1. CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆ
            2. TDDåŸå‰‡ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚‚å®Ÿè£…
            3. PRã‚µã‚¤ã‚ºã¯10ãƒ•ã‚¡ã‚¤ãƒ«/500è¡Œä»¥å†…
            4. è²¬å‹™åˆ†é›¢ã‚’éµå®ˆï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å¢ƒç•Œã‚’å®ˆã‚‹ï¼‰
            5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ï¼ˆSecretsã‚’ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰

            å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»ç·¨é›†ã—ã¦ã€å®Ÿè£…ã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚

      - name: Check implementation results
        id: check-impl
        run: |
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸ"

            # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¨ãƒ©ã‚¤ãƒ³æ•°ã‚’ãƒã‚§ãƒƒã‚¯
            FILES_CHANGED=$(git diff --name-only | wc -l)
            LINES_CHANGED=$(git diff --stat | tail -n 1 | awk '{print $4}')

            echo "ğŸ“Š å¤‰æ›´çµ±è¨ˆ:"
            echo "  - ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${FILES_CHANGED}"
            echo "  - å¤‰æ›´è¡Œæ•°: ${LINES_CHANGED}"

            # CLAUDE.mdã®åˆ¶é™ãƒã‚§ãƒƒã‚¯ (10ãƒ•ã‚¡ã‚¤ãƒ« / 500è¡Œ)
            if [ "$FILES_CHANGED" -gt 10 ] || [ "${LINES_CHANGED:-0}" -gt 500 ]; then
              echo "âš ï¸ è­¦å‘Š: å¤‰æ›´ãŒå¤§ãã™ãã¾ã™ï¼ˆåˆ¶é™: 10ãƒ•ã‚¡ã‚¤ãƒ«/500è¡Œï¼‰"
              echo "size_warning=true" >> $GITHUB_OUTPUT
            else
              echo "size_warning=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âŒ å®Ÿè£…ã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: Commit implementation
        if: steps.check-impl.outputs.has_changes == 'true'
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          git add .
          git commit -m "feat: Issue #${ISSUE_NUMBER} ã®è‡ªå‹•å®Ÿè£…

          ğŸ¤– AI ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…
          - TDDåŸå‰‡ã«åŸºã¥ã„ãŸãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å«ã‚€
          - CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ 

          Co-authored-by: Claude AI <claude-agent@anthropic.com>"

      - name: Push branch
        if: steps.check-impl.outputs.has_changes == 'true'
        run: |
          git push -u origin "${{ env.branch_name }}"
          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"

      - name: Trigger test workflow
        if: steps.check-impl.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = '${{ github.event.inputs.issue_number }}';
            const branchName = '${{ env.branch_name }}';

            console.log(`ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™...`);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-test.yml',
              ref: 'main',
              inputs: {
                issue_number: issueNumber,
                branch_name: branchName
              }
            });

            console.log(`âœ… ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ`);

      - name: Update issue on failure
        if: failure()
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "âŒ **å®Ÿè£…ã«å¤±æ•—ã—ã¾ã—ãŸ**

          ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã¯ [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

          äººé–“ã®ä»‹å…¥ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"

          gh issue edit "${ISSUE_NUMBER}" --remove-label "ai:implementing" --add-label "ai:failed"