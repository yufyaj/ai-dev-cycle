name: Main Orchestrator - Auto Implementation Pipeline

on:
  issues:
    types: [opened, labeled, edited]
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      force_issue_number:
        description: 'ç‰¹å®šã®Issueç•ªå·ã‚’å¼·åˆ¶å®Ÿè¡Œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰'
        required: false
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  check-and-dispatch:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyGithub requests

      - name: Check trigger type
        id: trigger-check
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
              echo "trigger_type=pr_merged" >> $GITHUB_OUTPUT
              echo "ğŸ‰ PR #${{ github.event.pull_request.number }} ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸ"
            else
              echo "trigger_type=skip" >> $GITHUB_OUTPUT
              echo "â­ï¸ PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã¦ã„ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—"
            fi
          elif [ "${{ github.event_name }}" = "issues" ]; then
            echo "trigger_type=issue_update" >> $GITHUB_OUTPUT
            echo "ğŸ“ Issue #${{ github.event.issue.number }} ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "trigger_type=manual" >> $GITHUB_OUTPUT
            echo "ğŸ”§ æ‰‹å‹•å®Ÿè¡ŒãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ"
          else
            echo "trigger_type=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Get prioritized issues
        if: steps.trigger-check.outputs.trigger_type != 'skip'
        id: get-issues
        run: |
          mkdir -p out
          python3 scripts/get_prioritized_issues.py

      - name: Select next issue
        if: steps.trigger-check.outputs.trigger_type != 'skip'
        id: select-issue
        run: |
          if [ -f out/prioritized_issues.json ]; then
            # å¼·åˆ¶å®Ÿè¡Œã® Issue ç•ªå·ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
            if [ -n "${{ github.event.inputs.force_issue_number }}" ]; then
              ISSUE_NUMBER="${{ github.event.inputs.force_issue_number }}"
              echo "ğŸ¯ å¼·åˆ¶å®Ÿè¡Œ: Issue #${ISSUE_NUMBER}"
            else
              # å„ªå…ˆåº¦é †ã§æœ€åˆã®å®Ÿè¡Œå¯èƒ½ãª Issue ã‚’é¸æŠ
              ISSUE_NUMBER=$(python3 << 'EOF'
              import json
              with open('out/prioritized_issues.json', 'r') as f:
                  issues = json.load(f)
                  for issue in issues:
                      if issue['status'] == 'ready':
                          print(issue['number'])
                          break
              EOF
              )
            fi

            if [ -n "$ISSUE_NUMBER" ]; then
              echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
              echo "has_issue=true" >> $GITHUB_OUTPUT
              echo "âœ… æ¬¡ã®å®Ÿè£…å¯¾è±¡: Issue #${ISSUE_NUMBER}"
            else
              echo "has_issue=false" >> $GITHUB_OUTPUT
              echo "â¸ï¸ å®Ÿè¡Œå¯èƒ½ãª Issue ãŒã‚ã‚Šã¾ã›ã‚“"
            fi
          else
            echo "has_issue=false" >> $GITHUB_OUTPUT
            echo "âŒ Issue ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi

      - name: Update issue status
        if: steps.select-issue.outputs.has_issue == 'true'
        env:
          ISSUE_NUMBER: ${{ steps.select-issue.outputs.issue_number }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸš€ **è‡ªå‹•å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… Issue è§£æå®Œäº†
          2. â³ å®Ÿè£…ä¸­...
          3. â³ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾…ã¡
          4. â³ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡
          5. â³ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å¾…ã¡
          6. â³ PRä½œæˆå¾…ã¡

          ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: [AIå®Ÿè£…ä¸­...]"

          # ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          gh issue edit "${ISSUE_NUMBER}" --add-label "ai:implementing"

      - name: Trigger implementation workflow
        if: steps.select-issue.outputs.has_issue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = '${{ steps.select-issue.outputs.issue_number }}';

            console.log(`ğŸš€ Issue #${issueNumber} ã®å®Ÿè£…ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™...`);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-implementation.yml',
              ref: 'main',
              inputs: {
                issue_number: issueNumber
              }
            });

            console.log(`âœ… Implementation ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ`);

      - name: Check for more issues
        if: steps.select-issue.outputs.has_issue == 'true'
        run: |
          echo "ğŸ”„ ã“ã®Issueã®å®Œäº†å¾Œã€æ¬¡ã®Issueã®å‡¦ç†ã‚’ç¶šã‘ã¾ã™"