name: 04 Auto Merge & Next

on:
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  merge-and-continue:
    if: github.event.check_suite.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Find a green PR
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            // 最も最近更新されたオープンPRを対象（必要なら厳密化可）
            const { data } = await github.rest.pulls.list({
              owner: context.repo.owner, repo: context.repo.repo, state: 'open', per_page: 10
            });
            if (!data.length) { core.setOutput('pr',''); return; }
            core.setOutput('pr', String(data[0].number));

      - name: Merge PR
        if: steps.pr.outputs.pr != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner, repo: context.repo.repo,
              pull_number: Number('${{ steps.pr.outputs.pr }}'),
              merge_method: 'squash'
            });

      - name: Close linked issue
        if: steps.pr.outputs.pr != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNum = Number('${{ steps.pr.outputs.pr }}');
            const pr = (await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prNum
            })).data;

            // PR本文に "Close #<n>" があれば自動Close
            const m = (pr.body || '').match(/#(\d+)/);
            if (m) {
              const issue = Number(m[1]);
              await github.rest.issues.update({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: issue, state: 'closed'
              });
              await github.rest.issues.removeLabel({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: issue, name: 'in-progress'
              }).catch(()=>{});
            }

      - name: Kick next issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner, repo: context.repo.repo,
              workflow_id: '02-orchestrate-next.yml',
              ref: context.payload.repository.default_branch
            });
