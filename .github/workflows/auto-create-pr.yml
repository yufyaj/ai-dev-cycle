name: Auto Create PR

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issueç•ªå·'
        required: true
        type: string
      branch_name:
        description: 'ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  create-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: write  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®dispatchæ¨©é™ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyGithub requests

      - name: Update issue status
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ“ **Pull Request ã‚’ä½œæˆä¸­**

          PRã«å«ã¾ã‚Œã‚‹å†…å®¹:
          - âœ… å®Ÿè£…å®Œäº†
          - âœ… ãƒ†ã‚¹ãƒˆåˆæ ¼
          - âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
          - âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Gather implementation summary
        id: gather-summary
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          # Issueæƒ…å ±ã‚’å–å¾—
          python3 << 'EOF'
          import os
          import json
          from github import Github

          g = Github(os.environ['GITHUB_TOKEN'])
          repo = g.get_repo(os.environ['GITHUB_REPOSITORY'])
          issue = repo.get_issue(int(os.environ['ISSUE_NUMBER']))

          # å¤‰æ›´ã®çµ±è¨ˆã‚’å–å¾—
          import subprocess
          diff_stat = subprocess.run(['git', 'diff', '--stat', 'origin/main..HEAD'],
                                    capture_output=True, text=True).stdout

          files_changed = subprocess.run(['git', 'diff', '--name-only', 'origin/main..HEAD'],
                                        capture_output=True, text=True).stdout.splitlines()

          # PRç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
          pr_data = {
            'issue_number': issue.number,
            'issue_title': issue.title,
            'issue_body': issue.body,
            'files_changed': files_changed,
            'diff_stat': diff_stat,
            'labels': [label.name for label in issue.labels]
          }

          with open('out/pr_data.json', 'w', encoding='utf-8') as f:
            json.dump(pr_data, f, ensure_ascii=False, indent=2)

          print(f"ğŸ“Š Issue #{issue.number}: {issue.title}")
          print(f"å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: {len(files_changed)}")
          EOF

      - name: Create PR with detailed description
        id: create-pr
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
          BRANCH_NAME: ${{ github.event.inputs.branch_name }}
        run: |
          python3 scripts/create_pr_from_issue.py

          # PRç•ªå·ã‚’å–å¾—
          PR_NUMBER=$(gh pr list --head "${BRANCH_NAME}" --json number --jq '.[0].number')
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT

          if [ -n "$PR_NUMBER" ]; then
            echo "âœ… PR #${PR_NUMBER} ã‚’ä½œæˆã—ã¾ã—ãŸ"
          else
            echo "âŒ PRä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: Add labels and assignees
        if: steps.create-pr.outputs.pr_number != ''
        env:
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          # PR ã«ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          gh pr edit "${PR_NUMBER}" --add-label "ai:generated" --add-label "auto-merge"

          # Issue ã‹ã‚‰ãƒ©ãƒ™ãƒ«ã‚’ç¶™æ‰¿
          ISSUE_LABELS=$(gh issue view "${ISSUE_NUMBER}" --json labels --jq '.labels[].name' | tr '\n' ',')
          if [ -n "$ISSUE_LABELS" ]; then
            gh pr edit "${PR_NUMBER}" --add-label "${ISSUE_LABELS%,}"
          fi

          # Issue ã‚’ãƒªãƒ³ã‚¯
          gh pr edit "${PR_NUMBER}" --body "$(gh pr view ${PR_NUMBER} --json body --jq '.body')

          Closes #${ISSUE_NUMBER}"

      - name: Enable auto-merge
        if: steps.create-pr.outputs.pr_number != ''
        env:
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
        run: |
          # Auto-merge ã‚’æœ‰åŠ¹åŒ–
          gh pr merge "${PR_NUMBER}" --auto --squash || echo "Auto-mergeè¨­å®šã«å¤±æ•—ï¼ˆæ¨©é™ä¸è¶³ã®å¯èƒ½æ€§ï¼‰"

      - name: Request review
        if: steps.create-pr.outputs.pr_number != ''
        env:
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
        run: |
          # CODEOWNERS ã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã‚’è‡ªå‹•è¨­å®š
          if [ -f .github/CODEOWNERS ]; then
            # CODEOWNERSã‹ã‚‰é©åˆ‡ãªãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã‚’æŠ½å‡ºï¼ˆç°¡ç•¥åŒ–ï¼‰
            echo "ğŸ“§ ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã‚’è‡ªå‹•è¨­å®šä¸­..."
          fi

          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒã„ã‚‹å ´åˆã¯è¨­å®š
          # gh pr edit "${PR_NUMBER}" --add-reviewer "username"

      - name: Update issue with PR link
        if: always()
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
        run: |
          if [ -n "${PR_NUMBER}" ]; then
            gh issue comment "${ISSUE_NUMBER}" --body "ğŸ‰ **Pull Request ã‚’ä½œæˆã—ã¾ã—ãŸï¼**

            PR: #${PR_NUMBER}

            å«ã¾ã‚Œã‚‹å¤‰æ›´:
            $(gh pr view ${PR_NUMBER} --json additions,deletions,changedFiles --jq '
            "- ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«: \(.changedFiles)
            - â• è¿½åŠ è¡Œ: \(.additions)
            - â– å‰Šé™¤è¡Œ: \(.deletions)"
            ')

            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:
            - âœ… å®Ÿè£…å®Œäº†
            - âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ
            - âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆã¿
            - âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†
            - â³ ãƒãƒ¼ã‚¸å¾…ã¡

            è‡ªå‹•ãƒãƒ¼ã‚¸ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚æ‰¿èªå¾Œã«è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚

            ---
            ğŸ¤– ã“ã®PRã¯AIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚"

            # Issue ã®ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
            gh issue edit "${ISSUE_NUMBER}" --remove-label "ai:implementing" --add-label "ai:pr-created"
          else
            gh issue comment "${ISSUE_NUMBER}" --body "âŒ **PRä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ**

            è©³ç´°ã¯ [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚"

            gh issue edit "${ISSUE_NUMBER}" --add-label "ai:pr-failed"
          fi

      - name: Trigger next issue if available
        if: steps.create-pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log(`ğŸ”„ æ¬¡ã®Issueã®å‡¦ç†ã‚’ç¢ºèªä¸­...`);

            // ãƒ¡ã‚¤ãƒ³ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å†åº¦èµ·å‹•
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'main-orchestrator.yml',
              ref: 'main'
            });

            console.log(`âœ… ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ`);

      - name: Generate final report
        if: always()
        run: |
          python3 << 'EOF'
          import json
          import os

          # æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
          report = {
            "issue_number": os.environ.get('ISSUE_NUMBER'),
            "branch": os.environ.get('BRANCH_NAME'),
            "pr_number": os.environ.get('PR_NUMBER'),
            "timestamp": os.popen('date -Iseconds').read().strip(),
            "status": "success" if os.environ.get('PR_NUMBER') else "failed",
            "pipeline_summary": {
              "implementation": "âœ…",
              "testing": "âœ…",
              "review": "âœ…",
              "security": "âœ…",
              "pr_creation": "âœ…" if os.environ.get('PR_NUMBER') else "âŒ"
            }
          }

          with open('out/final_report.json', 'w') as f:
            json.dump(report, f, indent=2)

          print("ğŸ“Š æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
          EOF
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
          BRANCH_NAME: ${{ github.event.inputs.branch_name }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}