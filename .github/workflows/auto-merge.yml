name: Auto Merge

on:
  pull_request_review:
    types: [submitted]

jobs:
  auto-merge:
    if: github.event.review.state == 'approved'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Check if all CI checks passed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # PR ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ç¢ºèª
          STATUS=$(gh pr view "${PR_NUMBER}" --json statusCheckRollup --jq '.statusCheckRollup[].conclusion' | grep -v "SUCCESS" | wc -l)

          if [ "$STATUS" -gt 0 ]; then
            echo "âš ï¸ CI ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¦ã„ãªã„ã‹ã€å¤±æ•—ã—ã¦ã„ã¾ã™"
            exit 1
          fi

          echo "âœ… å…¨ã¦ã®CIãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"

      - name: Enable auto-merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr merge "${PR_NUMBER}" --auto --squash

          echo "âœ… Auto-merge ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ"

      - name: Wait for merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # ãƒãƒ¼ã‚¸å®Œäº†ã‚’å¾…ã¤ï¼ˆæœ€å¤§5åˆ†ï¼‰
          for i in {1..30}; do
            STATUS=$(gh pr view "${PR_NUMBER}" --json state --jq '.state')
            if [ "$STATUS" == "MERGED" ]; then
              echo "âœ… PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸ"
              break
            fi
            echo "â³ ãƒãƒ¼ã‚¸å¾…æ©Ÿä¸­... (${i}/30)"
            sleep 10
          done

      - name: Close related issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # PRã‹ã‚‰é–¢é€£Issueã‚’å–å¾—
          ISSUE_NUMBER=$(gh pr view "${PR_NUMBER}" --json body --jq '.body' | grep -oP 'Closes #\K[0-9]+' | head -1)

          if [ -n "$ISSUE_NUMBER" ]; then
            gh issue close "${ISSUE_NUMBER}" --comment "âœ… Issue #${ISSUE_NUMBER} ã¯ PR #${PR_NUMBER} ã§ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚"
            echo "âœ… Issue #${ISSUE_NUMBER} ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ"
          fi

      - name: Trigger next issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Orchestrator ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œã—ã¦æ¬¡ã®Issueã‚’å‡¦ç†
          gh workflow run orchestrate-issues.yml

          echo "ğŸš€ æ¬¡ã®Issueã®å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ"

      - name: Post success comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr comment "${PR_NUMBER}" --body "ğŸ‰ **ãƒãƒ¼ã‚¸ãŒå®Œäº†ã—ã¾ã—ãŸï¼**

          é–¢é€£Issueã‚‚ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã€æ¬¡ã®Issueã®è‡ªå‹•å®Ÿè£…ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚

          ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼"
