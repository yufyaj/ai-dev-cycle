name: Implement Issue

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'å®Ÿè£…ã™ã‚‹Issueç•ªå·'
        required: true
        type: string

jobs:
  implement:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write

    env:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "Claude AI"
          git config user.email "claude@anthropic.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: |
          # Claude Code CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          # TODO: æ­£å¼ãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã«ç½®ãæ›ãˆ
          curl -fsSL https://claude.com/install-cli.sh | sh || true

      - name: Install dependencies
        run: |
          pip install PyGithub requests
          npm ci || echo "âš ï¸ package.json ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚å¾Œã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚"

      - name: Get Issue details
        id: issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          mkdir -p out
          python3 << 'EOF'
          import os, json
          from github import Github

          g = Github(os.environ['GITHUB_TOKEN'])
          repo = g.get_repo(os.environ['GITHUB_REPOSITORY'])
          issue = repo.get_issue(int(os.environ['ISSUE_NUMBER']))

          # Issueæƒ…å ±ã‚’å–å¾—
          issue_data = {
            'number': issue.number,
            'title': issue.title,
            'body': issue.body,
            'labels': [label.name for label in issue.labels]
          }

          # ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          with open('out/current_issue.json', 'w', encoding='utf-8') as f:
            json.dump(issue_data, f, ensure_ascii=False, indent=2)

          print(f"Issue #{issue.number}: {issue.title}")
          EOF

      - name: Create implementation branch
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          BRANCH_NAME="ai/cp-${ISSUE_NUMBER}"
          git checkout -b "${BRANCH_NAME}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_ENV
          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒä½œæˆ: ${BRANCH_NAME}"

      - name: Run Claude Code implementation
        id: implement
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          bash scripts/claude_implement.sh "${ISSUE_NUMBER}"

      - name: Run tests
        id: test
        continue-on-error: true
        run: |
          bash scripts/run_tests.sh

      - name: Retry implementation if tests failed
        if: steps.test.outcome == 'failure'
        run: |
          echo "âš ï¸ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚Claude Code CLIã§ä¿®æ­£ã‚’è©¦ã¿ã¾ã™..."

          bash scripts/claude_implement.sh "${ISSUE_NUMBER}" --fix-failures

      - name: Run tests again
        if: steps.test.outcome == 'failure'
        run: |
          bash scripts/run_tests.sh

      - name: Commit and push changes
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          git add .
          git commit -m "$(cat <<'EOF'
          feat: Issue #${ISSUE_NUMBER}ã®å®Ÿè£…

          Generated with Claude Code (https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )" || echo "å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"

          git push origin "${branch_name}"

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          # Issueæƒ…å ±ã‚’å–å¾—
          ISSUE_TITLE=$(jq -r '.title' out/current_issue.json)
          ISSUE_BODY=$(jq -r '.body' out/current_issue.json)

          # PRæœ¬æ–‡ã‚’ç”Ÿæˆ
          PR_BODY=$(cat << 'EOFPR'
          ## âœ… ç›®çš„
          Issue #${ISSUE_NUMBER} ã®å®Ÿè£…

          ## ğŸ§­ è¨­è¨ˆ
          - **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: CLAUDE.mdã®åŸå‰‡ã«å¾“ã„ã€UI/BFF/ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã®è²¬å‹™ã‚’åˆ†é›¢
          - **å®Ÿè£…ç¯„å›²**: è©³ç´°ã¯Issueå‚ç…§

          ## ğŸ§ª ãƒ†ã‚¹ãƒˆè¦³ç‚¹
          - âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: Jest/Vitestï¼ˆæ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ï¼‰
          - âœ… E2Eãƒ†ã‚¹ãƒˆ: Playwrightï¼ˆå…¨ã‚·ãƒŠãƒªã‚ªï¼‰
          - âœ… Acceptance Criteria: BRD.mdã®è¦ä»¶ã‚’æº€ãŸã™ã“ã¨ã‚’ç¢ºèª

          ## âš ï¸ å½±éŸ¿ç¯„å›²
          - æ–°è¦æ©Ÿèƒ½è¿½åŠ ï¼ˆæ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ãªã—ï¼‰
          - ä¾å­˜é–¢ä¿‚: Issueå‚ç…§

          ## ğŸ” ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †
          1. ã“ã®PRã‚’revert
          2. é–¢é€£ã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³/ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ãŒã‚ã‚Œã°æ‰‹å‹•ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

          ---

          Closes #${ISSUE_NUMBER}

          Generated with Claude Code (https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOFPR
          )

          # PRä½œæˆ
          gh pr create \
            --title "${ISSUE_TITLE}" \
            --body "${PR_BODY}" \
            --base main \
            --head "${branch_name}" \
            --label "ai:task"

          echo "âœ… PRä½œæˆå®Œäº†"

      - name: Comment on Issue
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸš€ å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚PRã‚’ã”ç¢ºèªãã ã•ã„ã€‚

          è‡ªå‹•ãƒ†ã‚¹ãƒˆçµæœ: âœ… PASS

          ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚"

      - name: Comment on Issue (failure)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "âš ï¸ å®Ÿè£…ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

          ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
