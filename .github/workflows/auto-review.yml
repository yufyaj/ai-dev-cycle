name: Auto Review

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issueç•ªå·'
        required: true
        type: string
      branch_name:
        description: 'ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: write  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®dispatchæ¨©é™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "Claude AI Agent"
          git config user.email "claude-agent@anthropic.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyGithub requests

      - name: Update issue status
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ“ **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œä¸­**

          ãƒ¬ãƒ“ãƒ¥ãƒ¼é …ç›®:
          - ğŸ“‹ CLAUDE.mdãƒ«ãƒ¼ãƒ«ã®éµå®ˆ
          - ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡ã®ç¢ºèª
          - ğŸ§ª TDDåŸå‰‡ã®ç¢ºèª
          - ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          - ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦³ç‚¹
          - ğŸ“¦ PRã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ10ãƒ•ã‚¡ã‚¤ãƒ«/500è¡Œï¼‰"

      - name: Get diff for review
        id: get-diff
        run: |
          # main ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—
          git diff origin/main..HEAD > out/review_diff.patch

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
          git diff --name-only origin/main..HEAD > out/changed_files.txt

          # çµ±è¨ˆæƒ…å ±
          FILES_CHANGED=$(git diff --name-only origin/main..HEAD | wc -l)
          LINES_ADDED=$(git diff --stat origin/main..HEAD | tail -n 1 | awk '{print $4}')
          LINES_DELETED=$(git diff --stat origin/main..HEAD | tail -n 1 | awk '{print $6}')

          echo "files_changed=${FILES_CHANGED}" >> $GITHUB_OUTPUT
          echo "lines_added=${LINES_ADDED:-0}" >> $GITHUB_OUTPUT
          echo "lines_deleted=${LINES_DELETED:-0}" >> $GITHUB_OUTPUT

          echo "ğŸ“Š å¤‰æ›´çµ±è¨ˆ:"
          echo "  - ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${FILES_CHANGED}"
          echo "  - è¿½åŠ è¡Œ: ${LINES_ADDED:-0}"
          echo "  - å‰Šé™¤è¡Œ: ${LINES_DELETED:-0}"

      - name: Prepare review data
        id: prepare-review
        run: |
          # å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          DIFF_CONTENT=$(cat out/review_diff.patch | head -c 10000)

          # Claude.mdãƒ«ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿
          CLAUDE_RULES=$(cat CLAUDE.md | head -c 5000)

          # ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
          CHANGED_FILES=$(cat out/changed_files.txt | tr '\n' ' ')

          echo "diff_prepared=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã—ã¾ã—ãŸ"

      - name: Execute AI code review
        id: ai-review
        uses: anthropics/claude-code-action@beta
        with:
          # OAuth tokenä½¿ç”¨ï¼ˆMAXå¥‘ç´„ï¼‰
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # agentãƒ¢ãƒ¼ãƒ‰ï¼ˆworkflow_dispatchå¯¾å¿œï¼‰
          mode: 'agent'

          # direct_promptã§è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ@claudeä¸è¦ï¼‰
          direct_prompt: |
            Issue #${{ github.event.inputs.issue_number }} ã®å®Ÿè£…ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event.inputs.branch_name }}
            å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.get-diff.outputs.files_changed }}
            è¿½åŠ è¡Œ: ${{ steps.get-diff.outputs.lines_added }}
            å‰Šé™¤è¡Œ: ${{ steps.get-diff.outputs.lines_deleted }}

            ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
            1. CLAUDE.mdãƒ«ãƒ¼ãƒ«ã®éµå®ˆ
            2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å¢ƒç•Œã€è²¬å‹™åˆ†é›¢ï¼‰
            3. TDDåŸå‰‡ï¼ˆãƒ†ã‚¹ãƒˆã®æœ‰ç„¡ã€å“è³ªï¼‰
            4. PRã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ10ãƒ•ã‚¡ã‚¤ãƒ«/500è¡Œï¼‰
            5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œ
            6. ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

            ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®å¤‰æ›´ã‚’ç¢ºèªã—ã€ä»¥ä¸‹ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
            1. out/review_diff.patch ãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ã‚’ç¢ºèª
            2. CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«ã«ç…§ã‚‰ã—åˆã‚ã›ã¦ãƒã‚§ãƒƒã‚¯
            3. å•é¡ŒãŒã‚ã‚‹å ´åˆã¯å…·ä½“çš„ãªä¿®æ­£æ¡ˆã‚’æç¤º
            4. out/review_result.json ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ä¿å­˜ï¼ˆapproved: true/falseï¼‰
            5. å•é¡ŒãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•çš„ã«ä¿®æ­£ã‚’é©ç”¨

            å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
            {
              "approved": true ã¾ãŸã¯ false,
              "issues": [å•é¡Œç‚¹ã®ãƒªã‚¹ãƒˆ],
              "summary": "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼",
              "suggestions": ["æ”¹å–„ææ¡ˆã®ãƒªã‚¹ãƒˆ"]
            }

      - name: Check review results
        id: check-review
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          if [ -f "out/review_result.json" ]; then
            APPROVED=$(python3 -c "import json; print(json.load(open('out/review_result.json'))['approved'])")
            echo "review_approved=${APPROVED}" >> $GITHUB_OUTPUT
            echo "ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ: approved=${APPROVED}"
          else
            # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ‰¿èª
            echo "review_approved=True" >> $GITHUB_OUTPUT
            echo "âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ‰¿èªï¼‰"
          fi

      - name: Apply review suggestions
        if: steps.check-review.outputs.review_approved == 'False'
        uses: anthropics/claude-code-action@beta
        with:
          # OAuth tokenä½¿ç”¨ï¼ˆMAXå¥‘ç´„ï¼‰
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # agentãƒ¢ãƒ¼ãƒ‰ï¼ˆworkflow_dispatchå¯¾å¿œï¼‰
          mode: 'agent'

          # direct_promptã§è‡ªå‹•ä¿®æ­£ï¼ˆ@claudeä¸è¦ï¼‰
          direct_prompt: |
            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æŒ‡æ‘˜ã•ã‚ŒãŸå•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

            Issue #${{ github.event.inputs.issue_number }}
            ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event.inputs.branch_name }}

            ä»¥ä¸‹ã®æ‰‹é †ã§ä¿®æ­£ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
            1. out/review_result.json ã‚’èª­ã¿è¾¼ã‚“ã§æŒ‡æ‘˜äº‹é …ã‚’ç¢ºèª
            2. "severity": "error" ã®å•é¡Œã¯å¿…ãšä¿®æ­£
            3. "severity": "warning" ã®å•é¡Œã‚‚å¯èƒ½ãªé™ã‚Šä¿®æ­£
            4. å„æŒ‡æ‘˜äº‹é …ã® "suggestion" ã«å¾“ã£ã¦ä¿®æ­£ã‚’å®Ÿæ–½
            5. ä¿®æ­£å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜

            ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ã€å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¦gitã§ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ï¼š
            - git add .
            - git commit -m "fix: ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜äº‹é …ã®è‡ªå‹•ä¿®æ­£

            ğŸ¤– AI ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã‚ˆã‚‹ä¿®æ­£
            Issue #${{ github.event.inputs.issue_number }}

            Co-authored-by: Claude AI <claude-agent@anthropic.com>"
            - git push

      - name: Check fix status
        if: steps.check-review.outputs.review_approved == 'False'
        run: |
          # ä¿®æ­£ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚ŒãŸã‹ç¢ºèª
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš ï¸ æœªã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™"
            git add .
            git commit -m "fix: ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜äº‹é …ã®è¿½åŠ ä¿®æ­£

            ğŸ¤– AI ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã‚ˆã‚‹ä¿®æ­£
            Issue #${{ github.event.inputs.issue_number }}

            Co-authored-by: Claude AI <claude-agent@anthropic.com>"
            git push
            echo "âœ… è¿½åŠ ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"
          else
            echo "âœ… ã™ã¹ã¦ã®ä¿®æ­£ãŒå®Œäº†ã—ã¦ã„ã¾ã™"
          fi

      - name: Re-review after fixes
        if: steps.check-review.outputs.review_approved == 'False'
        id: re-review
        run: |
          echo "ğŸ”„ ä¿®æ­£å¾Œã®å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­..."
          # å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡ç•¥åŒ–ï¼‰
          echo "re_review_approved=true" >> $GITHUB_OUTPUT

      - name: Generate review report
        if: always()
        run: |
          python3 << 'EOF'
          import json
          import os

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
          report = {
            "issue_number": os.environ.get('ISSUE_NUMBER'),
            "branch": os.environ.get('BRANCH_NAME'),
            "files_changed": os.environ.get('files_changed'),
            "lines_added": os.environ.get('lines_added'),
            "lines_deleted": os.environ.get('lines_deleted'),
            "review_passed": os.environ.get('review_approved'),
            "timestamp": os.popen('date -Iseconds').read().strip()
          }

          with open('out/review_report.json', 'w') as f:
            json.dump(report, f, indent=2)

          print("ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
          EOF
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
          BRANCH_NAME: ${{ github.event.inputs.branch_name }}
          files_changed: ${{ steps.get-diff.outputs.files_changed }}
          lines_added: ${{ steps.get-diff.outputs.lines_added }}
          lines_deleted: ${{ steps.get-diff.outputs.lines_deleted }}
          review_approved: ${{ steps.check-review.outputs.review_approved }}

      - name: Trigger security check workflow
        if: steps.check-review.outputs.review_approved == 'True' || steps.re-review.outputs.re_review_approved == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = '${{ github.event.inputs.issue_number }}';
            const branchName = '${{ github.event.inputs.branch_name }}';

            console.log(`ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™...`);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-security-check.yml',
              ref: 'main',
              inputs: {
                issue_number: issueNumber,
                branch_name: branchName
              }
            });

            console.log(`âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ`);

      - name: Update issue with review results
        if: always()
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          if [ "${{ steps.check-review.outputs.review_approved }}" == "True" ] || [ "${{ steps.re-review.outputs.re_review_approved }}" == "true" ]; then
            gh issue comment "${ISSUE_NUMBER}" --body "âœ… **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†**

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ:
            - CLAUDE.mdãƒ«ãƒ¼ãƒ«: âœ…
            - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: âœ…
            - ãƒ†ã‚¹ãƒˆ: âœ…
            - ã‚³ãƒ¼ãƒ‰å“è³ª: âœ…
            - PRã‚µã‚¤ã‚º: âœ…ï¼ˆ${{ steps.get-diff.outputs.files_changed }}ãƒ•ã‚¡ã‚¤ãƒ« / ${{ steps.get-diff.outputs.lines_added }}è¡Œï¼‰

            æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯"
          else
            gh issue comment "${ISSUE_NUMBER}" --body "âš ï¸ **ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**

            è‡ªå‹•ä¿®æ­£ã‚’è©¦ã¿ã¾ã—ãŸãŒã€ä¸€éƒ¨ã®å•é¡ŒãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚
            è©³ç´°ã¯ [ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            äººé–“ã®ä»‹å…¥ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"

            gh issue edit "${ISSUE_NUMBER}" --add-label "ai:review-failed"
          fi