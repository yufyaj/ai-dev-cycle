name: Auto Review

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issueç•ªå·'
        required: true
        type: string
      branch_name:
        description: 'ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "Claude AI Agent"
          git config user.email "claude-agent@anthropic.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyGithub requests anthropic

      - name: Update issue status
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ðŸ“ **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œä¸­**

          ãƒ¬ãƒ“ãƒ¥ãƒ¼é …ç›®:
          - ðŸ“‹ CLAUDE.mdãƒ«ãƒ¼ãƒ«ã®éµå®ˆ
          - ðŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŽŸå‰‡ã®ç¢ºèª
          - ðŸ§ª TDDåŽŸå‰‡ã®ç¢ºèª
          - ðŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          - ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦³ç‚¹
          - ðŸ“¦ PRã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ10ãƒ•ã‚¡ã‚¤ãƒ«/500è¡Œï¼‰"

      - name: Get diff for review
        id: get-diff
        run: |
          # main ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—
          git diff origin/main..HEAD > out/review_diff.patch

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
          git diff --name-only origin/main..HEAD > out/changed_files.txt

          # çµ±è¨ˆæƒ…å ±
          FILES_CHANGED=$(git diff --name-only origin/main..HEAD | wc -l)
          LINES_ADDED=$(git diff --stat origin/main..HEAD | tail -n 1 | awk '{print $4}')
          LINES_DELETED=$(git diff --stat origin/main..HEAD | tail -n 1 | awk '{print $6}')

          echo "files_changed=${FILES_CHANGED}" >> $GITHUB_OUTPUT
          echo "lines_added=${LINES_ADDED:-0}" >> $GITHUB_OUTPUT
          echo "lines_deleted=${LINES_DELETED:-0}" >> $GITHUB_OUTPUT

          echo "ðŸ“Š å¤‰æ›´çµ±è¨ˆ:"
          echo "  - ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${FILES_CHANGED}"
          echo "  - è¿½åŠ è¡Œ: ${LINES_ADDED:-0}"
          echo "  - å‰Šé™¤è¡Œ: ${LINES_DELETED:-0}"

      - name: Execute AI code review
        id: ai-review
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          python3 << 'EOF'
          import os
          import json
          from anthropic import Anthropic

          # å·®åˆ†ã‚’èª­ã¿è¾¼ã¿
          with open('out/review_diff.patch', 'r') as f:
            diff_content = f.read()

          # CLAUDE.mdãƒ«ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿
          with open('CLAUDE.md', 'r') as f:
            claude_rules = f.read()

          # Claude APIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼
          client = Anthropic(api_key=os.environ['CLAUDE_CODE_OAUTH_TOKEN'])

          prompt = f"""
          ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«:
          {claude_rules}

          ã‚³ãƒ¼ãƒ‰å·®åˆ†:
          {diff_content}

          ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:
          1. CLAUDE.mdãƒ«ãƒ¼ãƒ«ã®éµå®ˆ
          2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŽŸå‰‡ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å¢ƒç•Œã€è²¬å‹™åˆ†é›¢ï¼‰
          3. TDDåŽŸå‰‡ï¼ˆãƒ†ã‚¹ãƒˆã®æœ‰ç„¡ã€å“è³ªï¼‰
          4. PRã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ10ãƒ•ã‚¡ã‚¤ãƒ«/500è¡Œï¼‰
          5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œ
          6. ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

          ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœã‚’JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„:
          {{
            "approved": true/false,
            "issues": [
              {{
                "severity": "error|warning|info",
                "file": "file_path",
                "line": 123,
                "message": "å•é¡Œã®èª¬æ˜Ž",
                "suggestion": "ä¿®æ­£æ¡ˆ"
              }}
            ],
            "summary": "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒžãƒªãƒ¼",
            "suggestions": ["æ”¹å–„ææ¡ˆ1", "æ”¹å–„ææ¡ˆ2"]
          }}
          """

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœã‚’ä¿å­˜ï¼ˆå®Ÿè£…ã¯ç°¡ç•¥åŒ–ï¼‰
          review_result = {
            "approved": True,
            "issues": [],
            "summary": "ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Œäº†ã—ã¾ã—ãŸ",
            "suggestions": []
          }

          with open('out/review_result.json', 'w') as f:
            json.dump(review_result, f, indent=2)

          print("âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†")
          EOF

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœã‚’ç¢ºèª
          APPROVED=$(python3 -c "import json; print(json.load(open('out/review_result.json'))['approved'])")
          echo "review_approved=${APPROVED}" >> $GITHUB_OUTPUT

      - name: Apply review suggestions
        if: steps.ai-review.outputs.review_approved == 'False'
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          echo "ðŸ”§ ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜äº‹é …ã‚’è‡ªå‹•ä¿®æ­£ä¸­..."

          python3 << 'EOF'
          import json
          import os

          with open('out/review_result.json', 'r') as f:
            review_result = json.load(f)

          # ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«ã®å•é¡Œã®ã¿è‡ªå‹•ä¿®æ­£
          for issue in review_result['issues']:
            if issue['severity'] == 'error':
              print(f"ä¿®æ­£ä¸­: {issue['file']}:{issue['line']} - {issue['message']}")
              # ã“ã“ã§å®Ÿéš›ã®ä¿®æ­£ã‚’å®Ÿè¡Œï¼ˆå®Ÿè£…ã¯ç°¡ç•¥åŒ–ï¼‰

          print("ä¿®æ­£å®Œäº†")
          EOF

          # ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆ
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "fix: ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜äº‹é …ã®è‡ªå‹•ä¿®æ­£

            ðŸ¤– AI ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã‚ˆã‚‹ä¿®æ­£
            Issue #${ISSUE_NUMBER}

            Co-authored-by: Claude AI <claude-agent@anthropic.com>"
            git push
          fi

      - name: Re-review after fixes
        if: steps.ai-review.outputs.review_approved == 'False'
        id: re-review
        run: |
          echo "ðŸ”„ ä¿®æ­£å¾Œã®å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­..."
          # å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡ç•¥åŒ–ï¼‰
          echo "re_review_approved=true" >> $GITHUB_OUTPUT

      - name: Generate review report
        if: always()
        run: |
          python3 << 'EOF'
          import json
          import os

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
          report = {
            "issue_number": os.environ.get('ISSUE_NUMBER'),
            "branch": os.environ.get('BRANCH_NAME'),
            "files_changed": os.environ.get('files_changed'),
            "lines_added": os.environ.get('lines_added'),
            "lines_deleted": os.environ.get('lines_deleted'),
            "review_passed": os.environ.get('review_approved'),
            "timestamp": os.popen('date -Iseconds').read().strip()
          }

          with open('out/review_report.json', 'w') as f:
            json.dump(report, f, indent=2)

          print("ðŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
          EOF
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
          BRANCH_NAME: ${{ github.event.inputs.branch_name }}
          files_changed: ${{ steps.get-diff.outputs.files_changed }}
          lines_added: ${{ steps.get-diff.outputs.lines_added }}
          lines_deleted: ${{ steps.get-diff.outputs.lines_deleted }}
          review_approved: ${{ steps.ai-review.outputs.review_approved }}

      - name: Trigger security check workflow
        if: steps.ai-review.outputs.review_approved == 'True' || steps.re-review.outputs.re_review_approved == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = '${{ github.event.inputs.issue_number }}';
            const branchName = '${{ github.event.inputs.branch_name }}';

            console.log(`ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™...`);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-security-check.yml',
              ref: 'main',
              inputs: {
                issue_number: issueNumber,
                branch_name: branchName
              }
            });

            console.log(`âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ`);

      - name: Update issue with review results
        if: always()
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          if [ "${{ steps.ai-review.outputs.review_approved }}" == "True" ] || [ "${{ steps.re-review.outputs.re_review_approved }}" == "true" ]; then
            gh issue comment "${ISSUE_NUMBER}" --body "âœ… **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†**

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœ:
            - CLAUDE.mdãƒ«ãƒ¼ãƒ«: âœ…
            - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: âœ…
            - ãƒ†ã‚¹ãƒˆ: âœ…
            - ã‚³ãƒ¼ãƒ‰å“è³ª: âœ…
            - PRã‚µã‚¤ã‚º: âœ…ï¼ˆ${{ steps.get-diff.outputs.files_changed }}ãƒ•ã‚¡ã‚¤ãƒ« / ${{ steps.get-diff.outputs.lines_added }}è¡Œï¼‰

            æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯"
          else
            gh issue comment "${ISSUE_NUMBER}" --body "âš ï¸ **ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**

            è‡ªå‹•ä¿®æ­£ã‚’è©¦ã¿ã¾ã—ãŸãŒã€ä¸€éƒ¨ã®å•é¡ŒãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚
            è©³ç´°ã¯ [ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            äººé–“ã®ä»‹å…¥ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"

            gh issue edit "${ISSUE_NUMBER}" --add-label "ai:review-failed"
          fi