name: Auto Security Check

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issueç•ªå·'
        required: true
        type: string
      branch_name:
        description: 'ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  security-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: write  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®dispatchæ¨©é™
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "Claude AI Agent"
          git config user.email "claude-agent@anthropic.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          # AIåˆ†æç”¨ã®åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿
          pip install PyGithub requests

      - name: Update issue status
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­**

          ãƒã‚§ãƒƒã‚¯é …ç›®:
          - ğŸ” ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
          - ğŸ›¡ï¸ ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ
          - ğŸ”‘ Secretsãƒ»èªè¨¼æƒ…å ±ã®æ¤œå‡º
          - ğŸ“‹ OWASP Top 10 ãƒã‚§ãƒƒã‚¯
          - ğŸš¨ XSS/CSRFå¯¾ç­–ã®ç¢ºèª"

      - name: AI Security Analysis with Claude
        id: ai-security
        uses: anthropics/claude-code-action@beta
        with:
          # OAuth tokenä½¿ç”¨ï¼ˆMAXå¥‘ç´„ï¼‰
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # agentãƒ¢ãƒ¼ãƒ‰ï¼ˆworkflow_dispatchå¯¾å¿œï¼‰
          mode: 'agent'

          # direct_promptã§AIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æï¼ˆ@claudeä¸è¦ï¼‰
          direct_prompt: |
            Issue #${{ github.event.inputs.issue_number }} ã®å®Ÿè£…ã«å¯¾ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

            ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event.inputs.branch_name }}

            ä»¥ä¸‹ã®è¦³ç‚¹ã§åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š

            1. **Secretsãƒ»èªè¨¼æƒ…å ±ã®æ¤œå‡º**
               - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€APIã‚­ãƒ¼ã€ãƒˆãƒ¼ã‚¯ãƒ³
               - ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã‚„è¨¼æ˜æ›¸
               - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—
               - AWS/GCP/Azureã®ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«
               - ç’°å¢ƒå¤‰æ•°ã¸ã®é©åˆ‡ãªå¤–éƒ¨åŒ–ãŒå¿…è¦ãªå€¤

            2. **è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯**
               - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
               - XSSï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼‰
               - CSRFï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼‰
               - èªè¨¼ãƒ»èªå¯ã®ä¸å‚™
               - å®‰å…¨ã§ãªã„æš—å·åŒ–æ–¹å¼
               - ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«

            3. **OWASP Top 10ãƒã‚§ãƒƒã‚¯**
               - ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã®å¯èƒ½æ€§
               - èªè¨¼ã®æ¬ é™¥
               - æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®éœ²å‡º
               - XXEï¼ˆXMLå¤–éƒ¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰
               - ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®ä¸å‚™
               - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ä¸å‚™

            4. **ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
               - å…¥åŠ›æ¤œè¨¼ã®ä¸å‚™
               - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ã®æƒ…å ±æ¼æ´©
               - ãƒ­ã‚°ã¸ã®ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–æƒ…å ±è¨˜éŒ²
               - å®‰å…¨ã§ãªã„ä¹±æ•°ç”Ÿæˆ
               - ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³

            åˆ†æçµæœã‚’out/security_analysis.jsonã«ä»¥ä¸‹ã®å½¢å¼ã§ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
            {
              "has_critical_issues": true/false,
              "has_secrets": true/false,
              "issue_count": {
                "critical": æ•°å€¤,
                "high": æ•°å€¤,
                "medium": æ•°å€¤,
                "low": æ•°å€¤
              },
              "issues": [
                {
                  "severity": "critical|high|medium|low",
                  "type": "å•é¡Œã®ã‚¿ã‚¤ãƒ—",
                  "file": "ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹",
                  "description": "å•é¡Œã®èª¬æ˜",
                  "recommendation": "ä¿®æ­£æ–¹æ³•"
                }
              ],
              "summary": "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã®ã‚µãƒãƒªãƒ¼"
            }

            åˆ†æãŒå®Œäº†ã—ãŸã‚‰ã€çµæœã«åŸºã¥ã„ã¦é©åˆ‡ãªåˆ¤å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

      - name: Check AI security analysis results
        id: check-security
        run: |
          echo "ğŸ“Š AIåˆ†æçµæœã‚’ç¢ºèªä¸­..."

          # åˆ†æçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -f out/security_analysis.json ]; then
            # JSONã‹ã‚‰å€¤ã‚’æŠ½å‡º
            HAS_CRITICAL=$(python3 -c "import json; r=json.load(open('out/security_analysis.json')); print('true' if r.get('has_critical_issues', False) else 'false')")
            HAS_SECRETS=$(python3 -c "import json; r=json.load(open('out/security_analysis.json')); print('true' if r.get('has_secrets', False) else 'false')")
            CRITICAL_COUNT=$(python3 -c "import json; r=json.load(open('out/security_analysis.json')); print(r.get('issue_count', {}).get('critical', 0))")
            HIGH_COUNT=$(python3 -c "import json; r=json.load(open('out/security_analysis.json')); print(r.get('issue_count', {}).get('high', 0))")

            echo "has_critical_issues=${HAS_CRITICAL}" >> $GITHUB_OUTPUT
            echo "has_secrets=${HAS_SECRETS}" >> $GITHUB_OUTPUT
            echo "critical_issues=${CRITICAL_COUNT}" >> $GITHUB_OUTPUT
            echo "high_issues=${HIGH_COUNT}" >> $GITHUB_OUTPUT

            # ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
            python3 << 'EOF'
import json
with open('out/security_analysis.json', 'r') as f:
    data = json.load(f)
    print("\nğŸ“‹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚µãƒãƒªãƒ¼:")
    print(f"  ğŸš¨ Critical: {data['issue_count']['critical']}")
            print(f"  âš ï¸  High: {data['issue_count']['high']}")
            print(f"  âš¡ Medium: {data['issue_count']['medium']}")
            print(f"  ğŸ“ Low: {data['issue_count']['low']}")
            print(f"\n{data.get('summary', '')}")
EOF
          else
            # åˆ†æçµæœãŒãªã„å ´åˆï¼ˆClaude ActionãŒå¤±æ•—ã—ãŸå ´åˆï¼‰
            echo "âš ï¸ AIåˆ†æçµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
            echo "has_critical_issues=false" >> $GITHUB_OUTPUT
            echo "has_secrets=false" >> $GITHUB_OUTPUT
            echo "critical_issues=0" >> $GITHUB_OUTPUT
            echo "high_issues=0" >> $GITHUB_OUTPUT
          fi

      - name: Fix critical security issues with AI
        if: steps.check-security.outputs.has_critical_issues == 'true' || steps.check-security.outputs.has_secrets == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          # OAuth tokenä½¿ç”¨ï¼ˆMAXå¥‘ç´„ï¼‰
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # agentãƒ¢ãƒ¼ãƒ‰ï¼ˆworkflow_dispatchå¯¾å¿œï¼‰
          mode: 'agent'

          # direct_promptã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ï¼ˆ@claudeä¸è¦ï¼‰
          direct_prompt: |
            ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

            Issue #${{ github.event.inputs.issue_number }}
            ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event.inputs.branch_name }}

            ä»¥ä¸‹ã®æ‰‹é †ã§ä¿®æ­£ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
            1. out/security_analysis.json ã‚’èª­ã¿è¾¼ã‚“ã§æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã‚’ç¢ºèª
            2. criticalã¨highã®å•é¡Œã¯å¿…ãšä¿®æ­£
            3. SecretsãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯ç’°å¢ƒå¤‰æ•°ã«ç§»å‹•
            4. å„å•é¡Œã® "recommendation" ã«å¾“ã£ã¦ä¿®æ­£ã‚’å®Ÿæ–½

            ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ã€å¤‰æ›´å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ï¼š
            - git add .
            - git commit -m "fix: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®è‡ªå‹•ä¿®æ­£

            ğŸ”’ AIã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¿®æ­£
            Issue #${{ github.event.inputs.issue_number }}

            Co-authored-by: Claude AI <claude-agent@anthropic.com>"
            - git push

      - name: Generate security report
        if: always()
        run: |
          python3 << 'EOF'
          import json
          import os

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
          report = {
            "issue_number": os.environ.get('ISSUE_NUMBER'),
            "branch": os.environ.get('BRANCH_NAME'),
            "has_critical_issues": os.environ.get('has_critical_issues', 'false'),
            "has_secrets": os.environ.get('has_secrets', 'false'),
            "critical_count": os.environ.get('critical_issues', '0'),
            "high_count": os.environ.get('high_issues', '0'),
            "timestamp": os.popen('date -Iseconds').read().strip(),
            "passed": (
              os.environ.get('has_critical_issues') == 'false' and
              os.environ.get('has_secrets') == 'false'
            )
          }

          with open('out/security_summary.json', 'w') as f:
            json.dump(report, f, indent=2)

          print("ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
          EOF
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
          BRANCH_NAME: ${{ github.event.inputs.branch_name }}
          has_critical_issues: ${{ steps.check-security.outputs.has_critical_issues }}
          has_secrets: ${{ steps.check-security.outputs.has_secrets }}
          critical_issues: ${{ steps.check-security.outputs.critical_issues }}
          high_issues: ${{ steps.check-security.outputs.high_issues }}

      - name: Check if security passed
        id: security-result
        run: |
          PASSED=$(python3 -c "import json; print(json.load(open('out/security_summary.json'))['passed'])")
          echo "security_passed=${PASSED}" >> $GITHUB_OUTPUT

      - name: Trigger PR creation workflow
        if: steps.security-result.outputs.security_passed == 'True'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = '${{ github.event.inputs.issue_number }}';
            const branchName = '${{ github.event.inputs.branch_name }}';

            console.log(`ğŸš€ PRä½œæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™...`);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-create-pr.yml',
              ref: 'main',
              inputs: {
                issue_number: issueNumber,
                branch_name: branchName
              }
            });

            console.log(`âœ… PRä½œæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ`);

      - name: Update issue with security results
        if: always()
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          if [ "${{ steps.security-result.outputs.security_passed }}" == "True" ]; then
            gh issue comment "${ISSUE_NUMBER}" --body "âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†**

            AIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æçµæœ:
            - Secretsæ¤œå‡º: âœ… ãªã—
            - Criticalå•é¡Œ: âœ… ãªã—
            - Highå•é¡Œ: ${{ steps.check-security.outputs.high_issues }}å€‹
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: âœ… AIã«ã‚ˆã‚‹åŒ…æ‹¬çš„ãªåˆ†æå®Œäº†

            æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: PRä½œæˆ"
          else
            gh issue comment "${ISSUE_NUMBER}" --body "âš ï¸ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**

            AIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æçµæœ:
            - Secretsæ¤œå‡º: ${{ steps.check-security.outputs.has_secrets == 'true' && 'âš ï¸ æ¤œå‡º' || 'âœ… ãªã—' }}
            - Criticalå•é¡Œ: ${{ steps.check-security.outputs.critical_issues }}å€‹
            - Highå•é¡Œ: ${{ steps.check-security.outputs.high_issues }}å€‹

            è©³ç´°ã¯ [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            äººé–“ã®ä»‹å…¥ãŒå¿…è¦ã§ã™ã€‚"

            gh issue edit "${ISSUE_NUMBER}" --add-label "ai:security-failed"
          fi