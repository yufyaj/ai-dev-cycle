name: Auto Complete Pipeline

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'å®Ÿè£…ã™ã‚‹Issueç•ªå·'
        required: true
        type: string
      max_retry_count:
        description: 'å„ã‚¹ãƒ†ãƒƒãƒ—ã®æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°'
        required: false
        type: string
        default: '5'
      retry_count:
        description: 'ç¾åœ¨ã®ãƒªãƒˆãƒ©ã‚¤å›æ•°ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰'
        required: false
        type: string
        default: '0'
      feedback:
        description: 'å‰å›å®Ÿè¡Œã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰'
        required: false
        type: string
        default: ''
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: string
      max_retry_count:
        required: false
        type: string
        default: '5'
      retry_count:
        required: false
        type: string
        default: '0'
      feedback:
        required: false
        type: string
        default: ''

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
  ISSUE_NUMBER: ${{ inputs.issue_number }}
  MAX_RETRY: ${{ inputs.max_retry_count }}
  RETRY_COUNT: ${{ inputs.retry_count }}
  FEEDBACK: ${{ inputs.feedback }}

concurrency:
  group: auto-complete-${{ github.event.inputs.issue_number }}
  cancel-in-progress: true

jobs:
  # =====================================
  # JOB 1: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨å®Ÿè£…
  # =====================================
  setup-and-implement:
    name: "1ï¸âƒ£ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— & å®Ÿè£…"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
      issues: write
      actions: write
    outputs:
      branch_name: ${{ steps.create-branch.outputs.branch_name }}
      issue_title: ${{ steps.issue-details.outputs.title }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "Claude AI Agent"
          git config user.email "claude-agent@anthropic.com"

      - name: Get Issue details
        id: issue-details
        run: |
          gh issue view "${ISSUE_NUMBER}" --json number,title,body,labels > issue.json
          TITLE=$(jq -r '.title' issue.json)
          BODY=$(jq -r '.body // ""' issue.json)
          echo "title=${TITLE}" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Issue #${ISSUE_NUMBER}: ${TITLE}"

      - name: Create implementation branch
        id: create-branch
        run: |
          BRANCH_NAME="ai/cp-${ISSUE_NUMBER}"
          git checkout main
          git pull origin main
          git branch -D "${BRANCH_NAME}" 2>/dev/null || true
          git push origin --delete "${BRANCH_NAME}" 2>/dev/null || true
          git checkout -b "${BRANCH_NAME}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒä½œæˆå®Œäº†: ${BRANCH_NAME}"

      - name: Update issue status
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸš€ **çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³é–‹å§‹**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. â³ å®Ÿè£…ä¸­...
          2. â¹ï¸ å˜ä½“ãƒ†ã‚¹ãƒˆ
          3. â¹ï¸ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
          4. â¹ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          5. â¹ï¸ PRä½œæˆ"

      - name: Check for feedback
        id: check-feedback
        run: |
          if [ -n "${{ env.FEEDBACK }}" ]; then
            echo "ğŸ“ å‰å›å®Ÿè¡Œã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚Š:"
            echo "${{ env.FEEDBACK }}"
            echo "has_feedback=true" >> $GITHUB_OUTPUT
          else
            echo "has_feedback=false" >> $GITHUB_OUTPUT
          fi

      - name: Implementation with Claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: 'agent'
          direct_prompt: |
            Issue #${{ env.ISSUE_NUMBER }} ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

            ã‚¿ã‚¤ãƒˆãƒ«: ${{ steps.issue-details.outputs.title }}

            å†…å®¹:
            ${{ steps.issue-details.outputs.body }}

            ${{ steps.check-feedback.outputs.has_feedback == 'true' && format('âš ï¸ å‰å›å®Ÿè¡Œã§ã®å•é¡Œç‚¹ï¼ˆå¿…ãšå¯¾å¿œã—ã¦ãã ã•ã„ï¼‰:\n{0}\n\nã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã‚ˆã†å®Ÿè£…ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚', env.FEEDBACK) || '' }}

            ä»¥ä¸‹ã®è¦ä»¶ã‚’å®ˆã£ã¦ãã ã•ã„ï¼š
            1. docs/tech/*, docs/architecture/*, docs/requirements/BRD.md ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆ
            2. TDDåŸå‰‡ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚‚å®Ÿè£…
            3. è²¬å‹™åˆ†é›¢ã‚’éµå®ˆï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å¢ƒç•Œã‚’å®ˆã‚‹ï¼‰
            4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ï¼ˆSecretsã‚’ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰
            ${{ steps.check-feedback.outputs.has_feedback == 'true' && '6. å‰å›ã®å•é¡Œç‚¹ã‚’å¿…ãšè§£æ±ºã™ã‚‹' || '' }}

            ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ–¹é‡ï¼šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ docs/ ã«é›†ç´„ã—ã¾ã™ã€‚ä»¥ä¸‹ã‚’æº€ãŸã—ã¦ãã ã•ã„ã€‚
            - è¦ä»¶ãƒ»è¨­è¨ˆãƒ»ãƒ†ã‚¹ãƒˆè¦³ç‚¹ãƒ»ãƒªã‚¹ã‚¯ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®è¦ç‚¹ã‚’ docs/issues/${{ env.ISSUE_NUMBER }}/README.md ã«ã¾ã¨ã‚ã‚‹
            - å¿…è¦ã«å¿œã˜ã¦ docs/tech/* ã¾ãŸã¯ docs/architecture/* ã‚’æ›´æ–°
            - BRD ã¯ docs/requirements/BRD.md ã‚’æ­£ã¨ã™ã‚‹ï¼ˆå¿…è¦ãŒã‚ã‚Œã°æ›´æ–°ï¼‰

            å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»ç·¨é›†ã—ã¦ã€å®Ÿè£…ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚

      - name: Commit and push implementation
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "feat: Issue #${ISSUE_NUMBER} ã®å®Ÿè£…

            ğŸ¤– AI ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…
            - TDDåŸå‰‡ã«åŸºã¥ã„ãŸãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å«ã‚€
            - CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ 

            Co-authored-by: Claude AI <claude-agent@anthropic.com>"
            git push -u origin "${{ steps.create-branch.outputs.branch_name }}"
            echo "âœ… å®Ÿè£…ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi

      - name: Prepare workspace for next jobs
        run: |
          mkdir -p out
          echo "${{ steps.create-branch.outputs.branch_name }}" > out/branch_name.txt
          echo "${{ steps.issue-details.outputs.title }}" > out/issue_title.txt

      - name: Upload workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace
          path: out/

  # =====================================
  # JOB 2: å˜ä½“ãƒ†ã‚¹ãƒˆ
  # =====================================
  test:
    name: "2ï¸âƒ£ å˜ä½“ãƒ†ã‚¹ãƒˆ"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup-and-implement
    permissions:
      contents: write
      issues: write
      actions: write
    outputs:
      test_passed: ${{ steps.test-result.outputs.passed }}
      needs_reimplementation: ${{ steps.final-check.outputs.needs_reimplementation }}

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-and-implement.outputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup environment
        run: |
          git config user.name "Claude AI Agent"
          git config user.email "claude-agent@anthropic.com"

          # Pythonä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install PyGithub requests pytest pytest-cov

          # Node.jsä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆpackage.jsonãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          if [ -f package.json ]; then
            echo "ğŸ“¦ Node.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œå‡º - ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
            if [ -f package-lock.json ]; then
              echo "  package-lock.jsonä½¿ç”¨: npm ci"
              npm ci
            else
              echo "  package.jsonä½¿ç”¨: npm install"
              npm install
            fi

            # Playwright ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            if [ -f playwright.config.ts ] || [ -f playwright.config.js ]; then
              npx playwright install --with-deps || true
            fi
          fi

      - name: Download workspace
        uses: actions/download-artifact@v4
        with:
          name: workspace
          path: out/

      - name: Update issue status
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ§ª **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… å®Ÿè£…å®Œäº†
          2. â³ å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...
          3. â¹ï¸ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
          4. â¹ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          5. â¹ï¸ PRä½œæˆ"

      - name: Run tests
        id: test-execution
        continue-on-error: true
        run: |
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™..."
          python3 scripts/run_all_tests.py
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Check test results
        id: test-result
        run: |
          if [ "${{ steps.test-execution.outputs.exit_code }}" == "0" ]; then
            echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—"
            echo "passed=false" >> $GITHUB_OUTPUT
          fi
      - name: Determine if reimplementation needed
        id: final-check
        run: |
          if [ "${{ steps.test-result.outputs.passed }}" != "true" ]; then
            echo "ğŸ”„ ãƒ†ã‚¹ãƒˆå¤±æ•— - å†å®Ÿè£…ãŒå¿…è¦ã§ã™"
            echo "needs_reimplementation=true" >> $GITHUB_OUTPUT
            # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®é››å½¢ã‚’ä½œæˆ
            cat > out/feedback.txt << 'EOF'
          ãƒ†ã‚¹ãƒˆã§å¤±æ•—ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:
          - æœ€æ–°ã®ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã¯ out/test_results.log ã‚’å‚ç…§ã—ã¦ãã ã•ã„
          - è¨­è¨ˆã‚„ä¾å­˜ã®è¦‹ç›´ã—ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
          EOF
          else
            echo "needs_reimplementation=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: out/

  # =====================================
  # JOB 3: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
  # =====================================
  review:
    name: "3ï¸âƒ£ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test
    permissions:
      contents: write
      issues: write
      actions: write
    outputs:
      review_passed: ${{ steps.review-result.outputs.passed }}
      needs_reimplementation: ${{ steps.final-check.outputs.needs_reimplementation }}

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-and-implement.outputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup environment
        run: |
          git config user.name "Claude AI Agent"
          git config user.email "claude-agent@anthropic.com"
          mkdir -p out

      - name: Update issue status
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ“ **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… å®Ÿè£…å®Œäº†
          2. âœ… å˜ä½“ãƒ†ã‚¹ãƒˆæˆåŠŸ
          3. â³ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­...
          4. â¹ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          5. â¹ï¸ PRä½œæˆ"

      - name: Get diff for review
        run: |
          git diff origin/main..HEAD > out/review_diff.patch
          git diff --name-only origin/main..HEAD > out/changed_files.txt
          FILES_CHANGED=$(git diff --name-only origin/main..HEAD | wc -l)
          LINES_ADDED=$(git diff --stat origin/main..HEAD | tail -n 1 | awk '{print $4}')
          echo "ğŸ“Š å¤‰æ›´çµ±è¨ˆ: ${FILES_CHANGED}ãƒ•ã‚¡ã‚¤ãƒ« / ${LINES_ADDED:-0}è¡Œ"

      - name: Code review with Claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: 'agent'
          direct_prompt: |
            Issue #${{ env.ISSUE_NUMBER }} ã®å®Ÿè£…ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
            1. docs/tech/*, docs/architecture/*, docs/requirements/BRD.md ãƒ«ãƒ¼ãƒ«ã®éµå®ˆ
            2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å¢ƒç•Œã€è²¬å‹™åˆ†é›¢ï¼‰
            3. TDDåŸå‰‡ï¼ˆãƒ†ã‚¹ãƒˆã®æœ‰ç„¡ã€å“è³ªï¼‰
            4. ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’out/review_result.jsonã«ä»¥ä¸‹ã®å½¢å¼ã§ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
            {
              "approved": true/false,
              "has_critical_issues": true/false,
              "issues": [
                {
                  "severity": "critical|high|medium|low",
                  "file": "ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹",
                  "description": "å•é¡Œã®èª¬æ˜",
                  "suggestion": "ä¿®æ­£æ¡ˆ"
                }
              ],
              "summary": "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼"
            }

            ã‚‚ã—criticalã¾ãŸã¯highã®å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€è‡ªå‹•çš„ã«ä¿®æ­£ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

      - name: Check review results
        id: review-result
        run: |
          if [ -f out/review_result.json ]; then
            APPROVED=$(python3 -c "import json; r=json.load(open('out/review_result.json')); print('true' if r.get('approved', False) else 'false')")
            echo "passed=${APPROVED}" >> $GITHUB_OUTPUT
            if [ "$APPROVED" != "true" ]; then
              echo "âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            else
              echo "âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‰¿èª"
            fi
          else
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ‰¿èªï¼‰"
          fi

      - name: Determine if reimplementation needed
        id: final-check
        run: |
          if [ "${{ steps.review-result.outputs.passed }}" != "true" ]; then
            echo "ğŸ”„ ãƒ¬ãƒ“ãƒ¥ãƒ¼æœªæ‰¿èª - å†å®Ÿè£…ãŒå¿…è¦ã§ã™"
            echo "needs_reimplementation=true" >> $GITHUB_OUTPUT
            # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æƒ…å ±ã‚’ä½œæˆï¼ˆå¯èƒ½ãªã‚‰è©³ç´°ï¼‰
            if [ -f out/review_result.json ]; then
              python3 - <<'PY'
import json
r=json.load(open('out/review_result.json'))
fb=["ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"]
for i in r.get('issues', []):
  fb.append(f"- [{i.get('severity','')}] {i.get('description','')} ({i.get('file','N/A')})")
  if i.get('suggestion'): fb.append(f"  æ¨å¥¨: {i['suggestion']}")
open('out/feedback.txt','w').write('\n'.join(fb))
PY
            fi
          else
            echo "needs_reimplementation=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload review results
        uses: actions/upload-artifact@v4
        with:
          name: review-results
          path: out/

  # =====================================
  # JOB 4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  # =====================================
  security:
    name: "4ï¸âƒ£ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: review
    permissions:
      contents: write
      issues: write
      actions: write
      security-events: write
    outputs:
      security_passed: ${{ steps.security-result.outputs.passed }}
      needs_reimplementation: ${{ steps.final-check.outputs.needs_reimplementation }}

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-and-implement.outputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup environment
        run: |
          git config user.name "Claude AI Agent"
          git config user.email "claude-agent@anthropic.com"
          mkdir -p out

      - name: Update issue status
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ä¸­**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… å®Ÿè£…å®Œäº†
          2. âœ… å˜ä½“ãƒ†ã‚¹ãƒˆæˆåŠŸ
          3. âœ… ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
          4. â³ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ä¸­...
          5. â¹ï¸ PRä½œæˆ"

      - name: Security analysis with Claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: 'agent'
          direct_prompt: |
            Issue #${{ env.ISSUE_NUMBER }} ã®å®Ÿè£…ã«å¯¾ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

            ä»¥ä¸‹ã®è¦³ç‚¹ã§åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š

            1. **Secretsãƒ»èªè¨¼æƒ…å ±ã®æ¤œå‡º**
               - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€APIã‚­ãƒ¼ã€ãƒˆãƒ¼ã‚¯ãƒ³
               - ç’°å¢ƒå¤‰æ•°ã¸ã®é©åˆ‡ãªå¤–éƒ¨åŒ–ãŒå¿…è¦ãªå€¤

            2. **è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯**
               - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€CSRF
               - èªè¨¼ãƒ»èªå¯ã®ä¸å‚™
               - å®‰å…¨ã§ãªã„æš—å·åŒ–æ–¹å¼

            3. **OWASP Top 10ãƒã‚§ãƒƒã‚¯**

            4. **ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
               - å…¥åŠ›æ¤œè¨¼ã®ä¸å‚™
               - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ã®æƒ…å ±æ¼æ´©

            åˆ†æçµæœã‚’out/security_analysis.jsonã«ä»¥ä¸‹ã®å½¢å¼ã§ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
            {
              "has_critical_issues": true/false,
              "has_secrets": true/false,
              "issues": [
                {
                  "severity": "critical|high|medium|low",
                  "type": "å•é¡Œã®ã‚¿ã‚¤ãƒ—",
                  "file": "ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹",
                  "description": "å•é¡Œã®èª¬æ˜",
                  "recommendation": "ä¿®æ­£æ–¹æ³•"
                }
              ],
              "summary": "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã®ã‚µãƒãƒªãƒ¼"
            }

            ã‚‚ã—criticalãªå•é¡Œã‚„SecretsãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯ã€è‡ªå‹•çš„ã«ä¿®æ­£ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

      - name: Check security results
        id: security-result
        run: |
          if [ -f out/security_analysis.json ]; then
            HAS_CRITICAL=$(python3 -c "import json; r=json.load(open('out/security_analysis.json')); print('true' if r.get('has_critical_issues', False) else 'false')")
            HAS_SECRETS=$(python3 -c "import json; r=json.load(open('out/security_analysis.json')); print('true' if r.get('has_secrets', False) else 'false')")

            if [ "$HAS_CRITICAL" == "true" ] || [ "$HAS_SECRETS" == "true" ]; then
              echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
              echo "passed=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯åˆæ ¼"
              echo "passed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆæ ¼ï¼‰"
          fi

      - name: Determine if reimplementation needed
        id: final-check
        run: |
          if [ "${{ steps.security-result.outputs.passed }}" != "true" ]; then
            echo "ğŸ”„ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æœªåˆæ ¼ - å†å®Ÿè£…ãŒå¿…è¦ã§ã™"
            echo "needs_reimplementation=true" >> $GITHUB_OUTPUT
            if [ -f out/security_analysis.json ]; then
              python3 - <<'PY'
import json
s=json.load(open('out/security_analysis.json'))
fb=["ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"]
for i in s.get('issues', []):
  if i.get('severity') in ['high','critical']:
    fb.append(f"- [{i.get('severity')}] {i.get('description','')} ({i.get('file','N/A')})")
    if i.get('recommendation'): fb.append(f"  æ¨å¥¨: {i['recommendation']}")
if s.get('has_secrets'): fb.append('- Secretsã‚„èªè¨¼æƒ…å ±ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆç’°å¢ƒå¤‰æ•° or GitHub Secrets ã‚’ä½¿ç”¨ï¼‰')
open('out/feedback.txt','w').write('\n'.join(fb))
PY
            fi
          else
            echo "needs_reimplementation=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload security results
        uses: actions/upload-artifact@v4
        with:
          name: security-results
          path: out/

  # =====================================
  # JOB 5: PRä½œæˆ
  # =====================================
  create-pr:
    name: "5ï¸âƒ£ PRä½œæˆ"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [setup-and-implement, test, review, security]
    if: |
      always() &&
      needs.test.result == 'success' &&
      needs.review.result == 'success' &&
      needs.security.result == 'success' &&
      needs.test.outputs.needs_reimplementation != 'true' &&
      needs.review.outputs.needs_reimplementation != 'true' &&
      needs.security.outputs.needs_reimplementation != 'true'
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-and-implement.outputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update issue status
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ“‹ **PRä½œæˆä¸­**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… å®Ÿè£…å®Œäº†
          2. âœ… å˜ä½“ãƒ†ã‚¹ãƒˆæˆåŠŸ
          3. âœ… ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
          4. âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†
          5. â³ PRä½œæˆä¸­..."

      - name: Get change statistics
        id: stats
        run: |
          FILES_CHANGED=$(git diff --name-only origin/main..HEAD | wc -l)
          LINES_ADDED=$(git diff --stat origin/main..HEAD | tail -n 1 | awk '{print $4}')
          LINES_DELETED=$(git diff --stat origin/main..HEAD | tail -n 1 | awk '{print $6}')
          echo "files_changed=${FILES_CHANGED}" >> $GITHUB_OUTPUT
          echo "lines_added=${LINES_ADDED:-0}" >> $GITHUB_OUTPUT
          echo "lines_deleted=${LINES_DELETED:-0}" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create-pr
        run: |
          # æ—¢å­˜ã®PRã‚’ç¢ºèª
          EXISTING_PR=$(gh pr list --head "${{ needs.setup-and-implement.outputs.branch_name }}" --base main --json url --jq '.[0].url' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "âœ… æ—¢å­˜ã®PRã‚’ä½¿ç”¨: ${EXISTING_PR}"
            PR_URL="$EXISTING_PR"
          else
            # æ–°è¦PRä½œæˆ
            PR_URL=$(gh pr create \
              --title "feat: Issue #${ISSUE_NUMBER} - ${{ needs.setup-and-implement.outputs.issue_title }}" \
              --body "## ğŸ“‹ æ¦‚è¦
            Issue #${ISSUE_NUMBER} ã®è‡ªå‹•å®Ÿè£…

            ## âœ… å®Œäº†é …ç›®
            - ğŸ¤– AIã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…
            - ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»æˆåŠŸ
            - ğŸ“ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
            - ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†

            ## ğŸ“Š å¤‰æ›´çµ±è¨ˆ
            - ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.stats.outputs.files_changed }}
            - è¿½åŠ è¡Œ: ${{ steps.stats.outputs.lines_added }}
            - å‰Šé™¤è¡Œ: ${{ steps.stats.outputs.lines_deleted }}

            ## ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ
            å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã¾ã™ã€‚

            ## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
            ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã—ã¦ã„ã¾ã™ã€‚

            ## ğŸ¤– è‡ªå‹•ç”Ÿæˆ
            ã“ã®PRã¯çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

            Closes #${ISSUE_NUMBER}" \
              --head "${{ needs.setup-and-implement.outputs.branch_name }}" \
              --base main)
            echo "âœ… PRä½œæˆå®Œäº†: ${PR_URL}"
          fi

          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT

      - name: Update issue - Complete
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ‰ **çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†ï¼**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… å®Ÿè£…å®Œäº†
          2. âœ… å˜ä½“ãƒ†ã‚¹ãƒˆæˆåŠŸ
          3. âœ… ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
          4. âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†
          5. âœ… PRä½œæˆå®Œäº†

          ğŸ“Œ **Pull Request**: ${{ steps.create-pr.outputs.pr_url }}

          å…¨ã¦ã®å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚PRã®ãƒãƒ¼ã‚¸ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚"

          # ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          gh issue edit "${ISSUE_NUMBER}" --add-label "ai:completed" || echo "âš ï¸ ãƒ©ãƒ™ãƒ« 'ai:completed' ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"

      - name: Final summary
        run: |
          echo "======================================"
          echo "ğŸ“Š çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã‚µãƒãƒªãƒ¼"
          echo "======================================"
          echo "Issue: #${ISSUE_NUMBER}"
          echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ needs.setup-and-implement.outputs.branch_name }}"
          echo "PR URL: ${{ steps.create-pr.outputs.pr_url }}"
          echo ""
          echo "å„å·¥ç¨‹ã®çµæœ:"
          echo "  - å®Ÿè£…: âœ…"
          echo "  - ãƒ†ã‚¹ãƒˆ: ${{ needs.test.outputs.test_passed == 'true' && 'âœ…' || 'âš ï¸ (ä¿®æ­£æ¸ˆã¿)' }}"
          echo "  - ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${{ needs.review.outputs.review_passed == 'true' && 'âœ…' || 'âš ï¸ (ä¿®æ­£æ¸ˆã¿)' }}"
          echo "  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ${{ needs.security.outputs.security_passed == 'true' && 'âœ…' || 'âš ï¸ (ä¿®æ­£æ¸ˆã¿)' }}"
          echo "======================================"

  # =====================================
  # JOB 6: å†å®Ÿè£…åˆ¤å®šã¨å†å®Ÿè¡Œ
  # =====================================
  check-and-retry:
    name: "ğŸ”„ å†å®Ÿè£…åˆ¤å®š"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test, review, security]
    if: |
      always() && (
        needs.test.outputs.needs_reimplementation == 'true' ||
        needs.review.outputs.needs_reimplementation == 'true' ||
        needs.security.outputs.needs_reimplementation == 'true'
      )
    permissions:
      contents: read
      issues: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check retry count
        id: check-retry
        run: |
          CURRENT_RETRY=${{ env.RETRY_COUNT }}
          MAX_RETRY=${{ env.MAX_RETRY }}
          echo "ç¾åœ¨ã®ãƒªãƒˆãƒ©ã‚¤å›æ•°: $CURRENT_RETRY / $MAX_RETRY"

          if [ "$CURRENT_RETRY" -ge "$MAX_RETRY" ]; then
            echo "âŒ æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸ"
            echo "can_retry=false" >> $GITHUB_OUTPUT
          else
            echo "can_retry=true" >> $GITHUB_OUTPUT
            NEXT_RETRY=$((CURRENT_RETRY + 1))
            echo "next_retry=$NEXT_RETRY" >> $GITHUB_OUTPUT
          fi

      - name: Collect feedback
        if: steps.check-retry.outputs.can_retry == 'true'
        id: collect-feedback
        run: |
          mkdir -p out
          FEEDBACK=""

          # å„ã‚¸ãƒ§ãƒ–ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åé›†ï¼ˆç°¡ç•¥åŒ–ç‰ˆï¼‰
          echo "ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åé›†ä¸­..."

          if [ "${{ needs.test.outputs.needs_reimplementation }}" == "true" ]; then
            FEEDBACK="${FEEDBACK}[ãƒ†ã‚¹ãƒˆ] æ ¹æœ¬çš„ãªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ã‚„ä¾å­˜é–¢ä¿‚ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚\n"
          fi

          if [ "${{ needs.review.outputs.needs_reimplementation }}" == "true" ]; then
            FEEDBACK="${FEEDBACK}[ãƒ¬ãƒ“ãƒ¥ãƒ¼] ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n"
          fi

          if [ "${{ needs.security.outputs.needs_reimplementation }}" == "true" ]; then
            FEEDBACK="${FEEDBACK}[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£] Secretsã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¾ãŸã¯é‡å¤§ãªè„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n"
          fi

          # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¿å­˜
          echo -e "$FEEDBACK" > out/combined_feedback.txt
          echo "feedback<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FEEDBACK" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update issue with retry information
        if: steps.check-retry.outputs.can_retry == 'true'
        run: |
          gh issue comment "${{ env.ISSUE_NUMBER }}" --body "ğŸ”„ **å†å®Ÿè£…ãŒå¿…è¦ã§ã™**

          ãƒªãƒˆãƒ©ã‚¤å›æ•°: ${{ steps.check-retry.outputs.next_retry }} / ${{ env.MAX_RETRY }}

          æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ:
          - ãƒ†ã‚¹ãƒˆ: ${{ needs.test.outputs.needs_reimplementation == 'true' && 'è¦å†å®Ÿè£…' || 'OK' }}
          - ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${{ needs.review.outputs.needs_reimplementation == 'true' && 'è¦å†å®Ÿè£…' || 'OK' }}
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ${{ needs.security.outputs.needs_reimplementation == 'true' && 'è¦å†å®Ÿè£…' || 'OK' }}

          ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åŸºã«å†å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™..."

      - name: Trigger workflow retry
        if: steps.check-retry.outputs.can_retry == 'true'
        run: |
          echo "ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œã—ã¾ã™..."

          # ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼çµŒç”±ã§å†å®Ÿè¡Œ
          gh workflow run 02-orchestrate-next.yml \
            --field force_issue_number="${{ env.ISSUE_NUMBER }}"

      - name: Final failure notification
        if: steps.check-retry.outputs.can_retry == 'false'
        run: |
          # å†å®Ÿè¡Œç”¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä½œæˆ
          ESCAPED_FEEDBACK=$(echo "${{ steps.collect-feedback.outputs.feedback }}" | sed "s/'/''/g")

          gh issue comment "${{ env.ISSUE_NUMBER }}" --body "âŒ **è‡ªå‹•å®Ÿè£…å¤±æ•—**

          æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ï¼ˆ${{ env.MAX_RETRY }}å›ï¼‰ã«é”ã—ã¾ã—ãŸã€‚

          æ‰‹å‹•ã§ã®ä»‹å…¥ãŒå¿…è¦ã§ã™ã€‚ä»¥ä¸‹ã®å•é¡ŒãŒè§£æ±ºã§ãã¾ã›ã‚“ã§ã—ãŸ:
          - ãƒ†ã‚¹ãƒˆ: ${{ needs.test.outputs.needs_reimplementation == 'true' && 'âŒ æ ¹æœ¬çš„ãªå•é¡Œã‚ã‚Š' || 'âœ…' }}
          - ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${{ needs.review.outputs.needs_reimplementation == 'true' && 'âŒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å•é¡Œã‚ã‚Š' || 'âœ…' }}
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ${{ needs.security.outputs.needs_reimplementation == 'true' && 'âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚ã‚Š' || 'âœ…' }}

          ---


          ## ğŸ“ ç¶šãã‹ã‚‰å®Ÿè¡Œã™ã‚‹å ´åˆ

          æ‰‹å‹•ã§ä¿®æ­£å¾Œã€ã¾ãŸã¯ç¶šãã‹ã‚‰å†è©¦è¡Œã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š

          \`\`\`bash
          gh workflow run 02-orchestrate-next.yml \\
            --field force_issue_number=${{ env.ISSUE_NUMBER }}
          \`\`\`"

          # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
          echo ""
          echo "ğŸ“ ç¶šãã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨:"
          echo ""
          echo "gh workflow run auto-complete-pipeline.yml \\"
          echo "  --field issue_number=${{ env.ISSUE_NUMBER }} \\"
          echo "  --field max_retry_count=${{ env.MAX_RETRY }} \\"
          echo "  --field retry_count=${{ env.RETRY_COUNT }}"
          echo ""

          exit 1
