name: Auto Complete Pipeline

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'å®Ÿè£…ã™ã‚‹Issueç•ªå·'
        required: true
        type: string
      max_retry_count:
        description: 'å„ã‚¹ãƒ†ãƒƒãƒ—ã®æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°'
        required: false
        type: string
        default: '3'

jobs:
  complete-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
      security-events: write
      checks: write

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
      MAX_RETRY: ${{ github.event.inputs.max_retry_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup environment
        run: |
          # Gitè¨­å®š
          git config user.name "Claude AI Agent"
          git config user.email "claude-agent@anthropic.com"

          # Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          pip install PyGithub requests pytest pytest-cov

          # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p out

          # ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®åˆæœŸåŒ–
          echo "0" > out/test_retry_count
          echo "0" > out/review_retry_count
          echo "0" > out/security_retry_count

      - name: Get Issue details
        id: issue-details
        run: |
          # Issueæƒ…å ±ã‚’å–å¾—ã—ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          gh issue view "${ISSUE_NUMBER}" --json number,title,body,labels > issue.json

          # Issueæƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          TITLE=$(jq -r '.title' issue.json)
          BODY=$(jq -r '.body // ""' issue.json)
          echo "title=${TITLE}" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ Issue #${ISSUE_NUMBER}: ${TITLE}"

      - name: Create implementation branch
        id: create-branch
        run: |
          BRANCH_NAME="ai/cp-${ISSUE_NUMBER}"

          # main ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚’å–å¾—
          git checkout main
          git pull origin main

          # æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Œã°å‰Šé™¤
          git branch -D "${BRANCH_NAME}" 2>/dev/null || true
          git push origin --delete "${BRANCH_NAME}" 2>/dev/null || true

          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b "${BRANCH_NAME}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒä½œæˆå®Œäº†: ${BRANCH_NAME}"

      - name: Update issue status - Starting
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸš€ **çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³é–‹å§‹**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. â³ å®Ÿè£…ä¸­...
          2. â¹ï¸ å˜ä½“ãƒ†ã‚¹ãƒˆ
          3. â¹ï¸ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
          4. â¹ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          5. â¹ï¸ PRä½œæˆ

          æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°: ${MAX_RETRY}å›"

      # =====================================
      # STEP 1: å®Ÿè£…
      # =====================================
      - name: Implementation with Claude
        id: implementation
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: 'agent'
          direct_prompt: |
            Issue #${{ env.ISSUE_NUMBER }} ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

            ã‚¿ã‚¤ãƒˆãƒ«: ${{ steps.issue-details.outputs.title }}

            å†…å®¹:
            ${{ steps.issue-details.outputs.body }}

            ä»¥ä¸‹ã®è¦ä»¶ã‚’å®ˆã£ã¦ãã ã•ã„ï¼š
            1. CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆ
            2. TDDåŸå‰‡ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚‚å®Ÿè£…
            3. PRã‚µã‚¤ã‚ºã¯10ãƒ•ã‚¡ã‚¤ãƒ«/500è¡Œä»¥å†…
            4. è²¬å‹™åˆ†é›¢ã‚’éµå®ˆï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å¢ƒç•Œã‚’å®ˆã‚‹ï¼‰
            5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ï¼ˆSecretsã‚’ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰

            å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»ç·¨é›†ã—ã¦ã€å®Ÿè£…ã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚

      - name: Commit implementation
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "feat: Issue #${ISSUE_NUMBER} ã®å®Ÿè£…

            ğŸ¤– AI ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…
            - TDDåŸå‰‡ã«åŸºã¥ã„ãŸãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å«ã‚€
            - CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ 

            Co-authored-by: Claude AI <claude-agent@anthropic.com>"
            echo "âœ… å®Ÿè£…ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: Update issue status - Testing
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ“ **å®Ÿè£…å®Œäº† â†’ ãƒ†ã‚¹ãƒˆé–‹å§‹**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… å®Ÿè£…å®Œäº†
          2. â³ å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...
          3. â¹ï¸ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
          4. â¹ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          5. â¹ï¸ PRä½œæˆ"

      # =====================================
      # STEP 2: ãƒ†ã‚¹ãƒˆï¼ˆãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ—ä»˜ãï¼‰
      # =====================================
      - name: Run tests with retry
        id: test-phase
        run: |
          MAX_RETRY=${MAX_RETRY:-3}
          RETRY_COUNT=0
          TEST_PASSED=false

          while [ $RETRY_COUNT -lt $MAX_RETRY ]; do
            echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (è©¦è¡Œ $((RETRY_COUNT + 1))/${MAX_RETRY})"

            # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            python3 scripts/run_all_tests.py
            TEST_EXIT_CODE=$?

            if [ $TEST_EXIT_CODE -eq 0 ]; then
              echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ"
              TEST_PASSED=true
              break
            else
              echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•— (çµ‚äº†ã‚³ãƒ¼ãƒ‰: $TEST_EXIT_CODE)"

              if [ $RETRY_COUNT -lt $((MAX_RETRY - 1)) ]; then
                echo "ğŸ”§ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¾ã™..."

                # AIã«ã‚ˆã‚‹ä¿®æ­£
                cat > /tmp/fix_test_prompt.txt << 'PROMPT_EOF'
          ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

          ä»¥ä¸‹ã®æ‰‹é †ã§ä¿®æ­£ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
          1. out/test_results.log ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
          2. ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®š
          3. CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ä¿®æ­£ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
          4. TDDåŸå‰‡ã«åŸºã¥ã„ã¦ä¿®æ­£ï¼ˆãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«å®Ÿè£…ã‚’ä¿®æ­£ï¼‰
          5. ä¿®æ­£ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
          PROMPT_EOF

                # Claude Code Actionã¯ç›´æ¥å‘¼ã¹ãªã„ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§å‡¦ç†
                echo "AIã«ã‚ˆã‚‹ä¿®æ­£ã‚’è©¦ã¿ã¾ã™..."

                # ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆ
                if [ -n "$(git status --porcelain)" ]; then
                  git add .
                  git commit -m "fix: ãƒ†ã‚¹ãƒˆå¤±æ•—ã®ä¿®æ­£ (è©¦è¡Œ $((RETRY_COUNT + 1)))

                  ğŸ¤– AI ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆä¿®æ­£
                  Issue #${ISSUE_NUMBER}

                  Co-authored-by: Claude AI <claude-agent@anthropic.com>"
                fi

                RETRY_COUNT=$((RETRY_COUNT + 1))
              else
                echo "âš ï¸ æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸ"
                break
              fi
            fi
          done

          echo "test_passed=${TEST_PASSED}" >> $GITHUB_OUTPUT
          echo "${RETRY_COUNT}" > out/test_retry_count

      - name: Fix test failures with AI
        if: steps.test-phase.outputs.test_passed != 'true'
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: 'agent'
          direct_prompt: |
            ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

            Issue #${{ env.ISSUE_NUMBER }}

            ä»¥ä¸‹ã®æ‰‹é †ã§ä¿®æ­£ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
            1. out/test_results.log ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
            2. ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®š
            3. CLAUDE.mdã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ä¿®æ­£ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            4. TDDåŸå‰‡ã«åŸºã¥ã„ã¦ä¿®æ­£ï¼ˆãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«å®Ÿè£…ã‚’ä¿®æ­£ï¼‰
            5. ä¿®æ­£ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜

            ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ã€å¤‰æ›´å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ï¼š
            - git add .
            - git commit -m "fix: ãƒ†ã‚¹ãƒˆå¤±æ•—ã®è‡ªå‹•ä¿®æ­£

            ğŸ¤– AI ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆä¿®æ­£
            Issue #${{ env.ISSUE_NUMBER }}

            Co-authored-by: Claude AI <claude-agent@anthropic.com>"

      - name: Update issue status - Review
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ” **ãƒ†ã‚¹ãƒˆå®Œäº† â†’ ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… å®Ÿè£…å®Œäº†
          2. âœ… å˜ä½“ãƒ†ã‚¹ãƒˆæˆåŠŸ
          3. â³ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­...
          4. â¹ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          5. â¹ï¸ PRä½œæˆ"

      # =====================================
      # STEP 3: ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå•é¡ŒãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ãƒ†ã‚¹ãƒˆã‹ã‚‰å†å®Ÿè¡Œï¼‰
      # =====================================
      - name: Code review with Claude
        id: review-phase
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: 'agent'
          direct_prompt: |
            Issue #${{ env.ISSUE_NUMBER }} ã®å®Ÿè£…ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
            1. CLAUDE.mdãƒ«ãƒ¼ãƒ«ã®éµå®ˆ
            2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å¢ƒç•Œã€è²¬å‹™åˆ†é›¢ï¼‰
            3. TDDåŸå‰‡ï¼ˆãƒ†ã‚¹ãƒˆã®æœ‰ç„¡ã€å“è³ªï¼‰
            4. PRã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ10ãƒ•ã‚¡ã‚¤ãƒ«/500è¡Œï¼‰
            5. ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’out/review_result.jsonã«ä»¥ä¸‹ã®å½¢å¼ã§ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
            {
              "approved": true/false,
              "has_critical_issues": true/false,
              "issues": [
                {
                  "severity": "critical|high|medium|low",
                  "file": "ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹",
                  "description": "å•é¡Œã®èª¬æ˜",
                  "suggestion": "ä¿®æ­£æ¡ˆ"
                }
              ],
              "summary": "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼"
            }

            ã‚‚ã—criticalã¾ãŸã¯highã®å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€è‡ªå‹•çš„ã«ä¿®æ­£ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚
            ä¿®æ­£å¾Œã¯å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚

      - name: Check review results and fix if needed
        id: check-review
        run: |
          REVIEW_PASSED=true

          if [ -f out/review_result.json ]; then
            APPROVED=$(python3 -c "import json; r=json.load(open('out/review_result.json')); print('true' if r.get('approved', False) else 'false')")
            HAS_CRITICAL=$(python3 -c "import json; r=json.load(open('out/review_result.json')); print('true' if r.get('has_critical_issues', False) else 'false')")

            if [ "$APPROVED" != "true" ] || [ "$HAS_CRITICAL" == "true" ]; then
              echo "âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚"
              REVIEW_PASSED=false

              # ãƒ†ã‚¹ãƒˆã‹ã‚‰å†å®Ÿè¡ŒãŒå¿…è¦
              echo "need_test_rerun=true" >> $GITHUB_OUTPUT
            fi
          fi

          echo "review_passed=${REVIEW_PASSED}" >> $GITHUB_OUTPUT

      - name: Re-run tests after review fixes
        if: steps.check-review.outputs.need_test_rerun == 'true'
        run: |
          echo "ğŸ”„ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿®æ­£å¾Œã®ãƒ†ã‚¹ãƒˆã‚’å†å®Ÿè¡Œ..."
          python3 scripts/run_all_tests.py

          if [ $? -ne 0 ]; then
            echo "âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿®æ­£å¾Œã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          echo "âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿®æ­£å¾Œã®ãƒ†ã‚¹ãƒˆæˆåŠŸ"

      - name: Update issue status - Security
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ”’ **ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº† â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯é–‹å§‹**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… å®Ÿè£…å®Œäº†
          2. âœ… å˜ä½“ãƒ†ã‚¹ãƒˆæˆåŠŸ
          3. âœ… ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
          4. â³ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ä¸­...
          5. â¹ï¸ PRä½œæˆ"

      # =====================================
      # STEP 4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆå•é¡ŒãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ãƒ†ã‚¹ãƒˆã‹ã‚‰å†å®Ÿè¡Œï¼‰
      # =====================================
      - name: Security check with Claude
        id: security-phase
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: 'agent'
          direct_prompt: |
            Issue #${{ env.ISSUE_NUMBER }} ã®å®Ÿè£…ã«å¯¾ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

            ä»¥ä¸‹ã®è¦³ç‚¹ã§åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š

            1. **Secretsãƒ»èªè¨¼æƒ…å ±ã®æ¤œå‡º**
               - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€APIã‚­ãƒ¼ã€ãƒˆãƒ¼ã‚¯ãƒ³
               - ç’°å¢ƒå¤‰æ•°ã¸ã®é©åˆ‡ãªå¤–éƒ¨åŒ–ãŒå¿…è¦ãªå€¤

            2. **è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯**
               - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€CSRF
               - èªè¨¼ãƒ»èªå¯ã®ä¸å‚™
               - å®‰å…¨ã§ãªã„æš—å·åŒ–æ–¹å¼

            3. **OWASP Top 10ãƒã‚§ãƒƒã‚¯**

            4. **ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
               - å…¥åŠ›æ¤œè¨¼ã®ä¸å‚™
               - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ã®æƒ…å ±æ¼æ´©

            åˆ†æçµæœã‚’out/security_analysis.jsonã«ä»¥ä¸‹ã®å½¢å¼ã§ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
            {
              "has_critical_issues": true/false,
              "has_secrets": true/false,
              "issues": [
                {
                  "severity": "critical|high|medium|low",
                  "type": "å•é¡Œã®ã‚¿ã‚¤ãƒ—",
                  "file": "ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹",
                  "description": "å•é¡Œã®èª¬æ˜",
                  "recommendation": "ä¿®æ­£æ–¹æ³•"
                }
              ],
              "summary": "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã®ã‚µãƒãƒªãƒ¼"
            }

            ã‚‚ã—criticalãªå•é¡Œã‚„SecretsãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯ã€è‡ªå‹•çš„ã«ä¿®æ­£ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

      - name: Check security results and fix if needed
        id: check-security
        run: |
          SECURITY_PASSED=true

          if [ -f out/security_analysis.json ]; then
            HAS_CRITICAL=$(python3 -c "import json; r=json.load(open('out/security_analysis.json')); print('true' if r.get('has_critical_issues', False) else 'false')")
            HAS_SECRETS=$(python3 -c "import json; r=json.load(open('out/security_analysis.json')); print('true' if r.get('has_secrets', False) else 'false')")

            if [ "$HAS_CRITICAL" == "true" ] || [ "$HAS_SECRETS" == "true" ]; then
              echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚"
              SECURITY_PASSED=false

              # ãƒ†ã‚¹ãƒˆã‹ã‚‰å†å®Ÿè¡ŒãŒå¿…è¦
              echo "need_test_rerun=true" >> $GITHUB_OUTPUT
            fi
          fi

          echo "security_passed=${SECURITY_PASSED}" >> $GITHUB_OUTPUT

      - name: Re-run tests after security fixes
        if: steps.check-security.outputs.need_test_rerun == 'true'
        run: |
          echo "ğŸ”„ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£å¾Œã®ãƒ†ã‚¹ãƒˆã‚’å†å®Ÿè¡Œ..."
          python3 scripts/run_all_tests.py

          if [ $? -ne 0 ]; then
            echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£å¾Œã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£å¾Œã®ãƒ†ã‚¹ãƒˆæˆåŠŸ"

      - name: Push branch
        run: |
          git push -u origin "${{ steps.create-branch.outputs.branch_name }}"
          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"

      - name: Update issue status - PR Creation
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ“ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº† â†’ PRä½œæˆ**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… å®Ÿè£…å®Œäº†
          2. âœ… å˜ä½“ãƒ†ã‚¹ãƒˆæˆåŠŸ
          3. âœ… ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
          4. âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†
          5. â³ PRä½œæˆä¸­..."

      # =====================================
      # STEP 5: PRä½œæˆ
      # =====================================
      - name: Create Pull Request
        id: create-pr
        run: |
          # å¤‰æ›´å†…å®¹ã®ã‚µãƒãƒªãƒ¼ã‚’å–å¾—
          FILES_CHANGED=$(git diff --name-only origin/main..HEAD | wc -l)
          LINES_ADDED=$(git diff --stat origin/main..HEAD | tail -n 1 | awk '{print $4}')
          LINES_DELETED=$(git diff --stat origin/main..HEAD | tail -n 1 | awk '{print $6}')

          # PRã‚’ä½œæˆ
          PR_URL=$(gh pr create \
            --title "feat: Issue #${ISSUE_NUMBER} - ${{ steps.issue-details.outputs.title }}" \
            --body "$(cat <<'PR_BODY'
          ## ğŸ“‹ æ¦‚è¦
          Issue #${{ env.ISSUE_NUMBER }} ã®è‡ªå‹•å®Ÿè£…

          ## âœ… å®Œäº†é …ç›®
          - ğŸ¤– AIã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…
          - ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»æˆåŠŸ
          - ğŸ“ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
          - ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†

          ## ğŸ“Š å¤‰æ›´çµ±è¨ˆ
          - ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${FILES_CHANGED}
          - è¿½åŠ è¡Œ: ${LINES_ADDED:-0}
          - å‰Šé™¤è¡Œ: ${LINES_DELETED:-0}

          ## ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ
          å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã¾ã™ã€‚

          ## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã—ã¦ã„ã¾ã™ã€‚

          ## ğŸ¤– è‡ªå‹•ç”Ÿæˆ
          ã“ã®PRã¯çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

          Closes #${{ env.ISSUE_NUMBER }}
          PR_BODY
          )" \
            --head "${{ steps.create-branch.outputs.branch_name }}" \
            --base main)

          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          echo "âœ… PRä½œæˆå®Œäº†: ${PR_URL}"

      - name: Update issue - Complete
        run: |
          gh issue comment "${ISSUE_NUMBER}" --body "ğŸ‰ **çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†ï¼**

          å‡¦ç†ãƒ•ãƒ­ãƒ¼:
          1. âœ… å®Ÿè£…å®Œäº†
          2. âœ… å˜ä½“ãƒ†ã‚¹ãƒˆæˆåŠŸ
          3. âœ… ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
          4. âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†
          5. âœ… PRä½œæˆå®Œäº†

          ğŸ“Œ **Pull Request**: ${{ steps.create-pr.outputs.pr_url }}

          å…¨ã¦ã®å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚PRã®ãƒãƒ¼ã‚¸ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚"

          # å®Œäº†ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          gh issue edit "${ISSUE_NUMBER}" --add-label "ai:completed"

      - name: Final summary
        if: always()
        run: |
          echo "======================================"
          echo "ğŸ“Š çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã‚µãƒãƒªãƒ¼"
          echo "======================================"
          echo "Issue: #${ISSUE_NUMBER}"
          echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.create-branch.outputs.branch_name }}"
          echo "PR URL: ${{ steps.create-pr.outputs.pr_url }}"
          echo ""
          echo "ãƒ†ã‚¹ãƒˆãƒªãƒˆãƒ©ã‚¤å›æ•°: $(cat out/test_retry_count)"
          echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ steps.check-review.outputs.review_passed }}"
          echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ steps.check-security.outputs.security_passed }}"
          echo "======================================"