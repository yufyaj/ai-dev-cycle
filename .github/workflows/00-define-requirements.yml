name: 00 Define Requirements

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'BRDå®šç¾©ã®å…ƒã¨ãªã‚‹Issueç•ªå·ï¼ˆä»»æ„ã€‚æœªæŒ‡å®šãªã‚‰ç›´å…¥åŠ›ã®ã¿ï¼‰'
        required: false
        type: string
      prompt:
        description: 'è¦ä»¶ã®èƒŒæ™¯/ç›®çš„ãƒ»åˆ¶ç´„ãªã©ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
  issues:
    types: [labeled]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write
  issues: write

concurrency:
  group: define-requirements-${{ github.event.inputs.issue_number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  define-brd:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && contains(github.event.label.name, 'brd:request'))
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install validators
        run: |
          pip install -q -U pip
          pip install -q PyGithub requests

      - name: Resolve requirement input
        id: input
        run: |
          echo "ğŸ“ è¦ä»¶å…¥åŠ›ã‚’åé›†ã—ã¾ã™"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUM="${{ inputs.issue_number }}"
            PROMPT="${{ inputs.prompt }}"
          else
            ISSUE_NUM="${{ github.event.issue.number }}"
            PROMPT=""
          fi

          if [ -n "$ISSUE_NUM" ]; then
            gh issue view "$ISSUE_NUM" --json body,title > issue.json
            TITLE=$(jq -r .title issue.json)
            BODY=$(jq -r .body issue.json)
            echo "title=$TITLE" >> $GITHUB_OUTPUT
            echo "source_issue=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "prompt<<EOF" >> $GITHUB_OUTPUT
            echo "$BODY" >> $GITHUB_OUTPUT
            echo "\n---\nè¿½åŠ æƒ…å ±:\n${PROMPT}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "source_issue=" >> $GITHUB_OUTPUT
            echo "title=BRD" >> $GITHUB_OUTPUT
            echo "prompt<<EOF" >> $GITHUB_OUTPUT
            echo "${PROMPT}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Generate/Refine BRD with Claude (attempt 1)
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: agent
          direct_prompt: |
            ã‚ãªãŸã¯ .claude/commands/brd.md ã®è¦ç´„ã«å¾“ã£ã¦ã€docs/requirements/BRD.md ã‚’ç”Ÿæˆãƒ»æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
            å…¥åŠ›ï¼ˆèƒŒæ™¯/ç›®çš„/åˆ¶ç´„ãªã©ï¼‰:
            ---
            ${{ steps.input.outputs.prompt }}
            ---

      - name: Validate BRD (attempt 1)
        id: v1
        continue-on-error: true
        run: |
          python3 scripts/validate_brd.py --json > out.json || true
          cat out.json
          OK=$(jq -r .ok out.json)
          echo "ok=$OK" >> $GITHUB_OUTPUT

      - name: Refine BRD with Claude (attempt 2)
        if: steps.v1.outputs.ok != 'true'
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: agent
          direct_prompt: |
            `python3 scripts/validate_brd.py --json` ã®çµæœãŒNGã§ã—ãŸã€‚`out.json` ã® `errors` ã‚’ã™ã¹ã¦è§£æ¶ˆã™ã‚‹ã‚ˆã†ã« requirements/BRD.md ã‚’æœ€å°å¤‰æ›´ã§ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
            ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ:
            ${{ steps.v1.outputs.ok == 'true' && '' || format('{{0}}', steps.v1.outputs.ok) }}

      - name: Validate BRD (attempt 2)
        id: v2
        if: steps.v1.outputs.ok != 'true'
        continue-on-error: true
        run: |
          python3 scripts/validate_brd.py --json > out2.json || true
          cat out2.json
          OK=$(jq -r .ok out2.json)
          echo "ok=$OK" >> $GITHUB_OUTPUT

      - name: Finalize and Comment
        run: |
          echo "âœ… BRDãŒæ•´å‚™ã•ã‚Œã¾ã—ãŸã€‚"
          if [ -n "${{ steps.input.outputs.source_issue }}" ]; then
            gh issue comment "${{ steps.input.outputs.source_issue }}" --body "BRDã®ç”Ÿæˆ/æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n- ãƒ•ã‚¡ã‚¤ãƒ«: docs/requirements/BRD.md\n- è‡ªå‹•æ¤œè¨¼: æˆåŠŸ\n\nã“ã®IssueãŒè¦ä»¶å®šç¾©ç”¨ã§ã‚ã‚Œã°ã€'brd:ready' ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ã—ã€æ¬¡ã® '01 Plan Issues' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
            gh issue edit "${{ steps.input.outputs.source_issue }}" --add-label "brd:ready" || true
          fi
