# CLAUDE Rules — Architecture-First / Tech-Agnostic

あなたはこのリポジトリにおいて、AIエンジニア兼レビュワーとして開発に参加します。  
要件は Issue で管理し、クリティカルパス順に小さな単位で自動実装を進めます。  
**技術固有の情報はこのファイルに記載しない**。実装方針・構成・コマンドは `profiles/` 配下のスタックプロファイルに従います。

---

## 🧭 0. 基本方針
- 1PR = 1機能。**PRサイズは 10ファイル / 500行以内**。
- 実装は **TDD**（テスト駆動）を原則とし、PRにはテストを含める。
- 不明確な仕様は勝手に拡張せず、PR本文に補足・提案を記載。
- Secrets や認証情報はリポジトリに含めない。
- **責務境界を超える実装は禁止**。

---

## 🧱 1. アーキテクチャ原則（抽象）

### レイヤー境界
- **UI層**：表示と最小限の入力検証
- **BFF層**：認証・トレース・軽微な整形などの「中継のみ」
- **アプリケーション層（ユースケース）**：ビジネスロジックの中核
- **ドメイン層**：フレームワーク非依存の純粋ロジック
- **インフラ層**：外部依存（DB、外部API、IO）

### 境界の原則
- 外部I/Fとの境界は DTO を介して明確にする
- 上位層は下位層の契約にのみ依存し、実装に依存しない
- 依存方向は常に内向き（UI→BFF→アプリケーション→ドメイン）

---

## 🧠 2. 実装原則（技術非依存）

- ディレクトリ構成はスタックプロファイルで規定するが、責務の物理分離は必須。
- コントローラ／ハンドラはユースケースのみ呼び出す。
- ドメインは他レイヤーを参照しない。
- テストは正常系・異常系をセットで実施する。

---

## 🌐 3. フロントエンド方針（抽象）

- UIは表示とローカル状態管理に責務を限定。
- BFFは中継層として認証、トレース伝搬、軽微な整形、入力検証のみを担う。
- 型と契約は1か所で管理し、UI層とBFFで不整合を起こさない。
- グローバルストアの乱用は禁止。局所状態とサーバー状態を明確に分離。

---

## 🧪 4. テスト方針（抽象）

- すべてのPRに正常系＋異常系テストを含める。
- 各レイヤーはユニットテスト可能な構造にする。
- インタフェース層はI/O透過性のテストを実施。
- テスト実行方法やツールはスタックプロファイルに従う。

---

## 🔐 5. セキュリティ・信頼性

- XSS / CSRF 対策を初期設計に含める。
- 認証情報はサーバーサイドで安全に取り扱う。
- トレーシング（traceparent等）を全層で前方伝搬する。
- CSP / HTTPS / セキュアヘッダを有効化。
- Secretsはバージョン管理に含めない。

---

## 🕵️ 6. 観測性

- 全リクエストに一意のトレースIDを付与。
- BFFとバックエンドでログ相関可能にする。
- UI層ではエラーバウンダリとログ転送を活用。
- パフォーマンスとUXの主要メトリクス（例：Web Vitals）を監視対象に含める。

---

## 🧰 7. コーディング規約（共通）

- **ブランチ名**：`ai/cp-<issue-number>`
- **PRタイトル**：`feat: ...` または `fix: ...`
- **PR本文**（必須）：
  - ✅ 目的
  - 🧭 設計（責務・レイヤー位置）
  - 🧪 テスト観点
  - ⚠️ 影響範囲
  - 🔁 ロールバック手順
- 依存注入は明示的に。暗黙依存は禁止。
- 具体的なLint/Formatter/CIルールはスタックプロファイルに従う。

---

## 🔁 8. CI失敗時の対応

- Lint / Test / Static Analysis が失敗した場合：
  - Claudeはログを読み、修正コミットを追加して再試行する。
  - 不明確な失敗は PR 本文に補足し、最小実装に留める。

---

## 🧼 9. 禁止事項

- 巨大PR（>500行）
- ビジネスロジックを BFF や UI 層に置くこと
- ドメイン層からフレームワークを参照すること
- Secrets のコミット
- 型や契約のない API 呼び出し

---

## 📌 10. 参照

- 技術スタック・ディレクトリ構成・ツール／コマンド：
  → `profiles/stack_*.md` を参照
- Clean Architecture（Robert C. Martin）
- Web Vitals（UX監視指標）
