#!/bin/bash
set -euo pipefail

# Claude Code CLIã‚’ä½¿ã£ã¦PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹

PR_NUMBER="$1"

echo "ğŸ” PR #${PR_NUMBER} ã®AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹ã—ã¾ã™..."

# PRã®å¤‰æ›´å†…å®¹ã‚’å–å¾—
gh pr diff "${PR_NUMBER}" > out/pr_diff.txt

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
PROMPT=$(cat <<EOF
PR #${PR_NUMBER} ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ã€‘
1. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¢ƒç•Œ**: CLAUDE.mdã®åŸå‰‡ã«å¾“ã£ã¦ã„ã‚‹ã‹
   - UIå±¤: è¡¨ç¤ºã¨æœ€å°é™ã®å…¥åŠ›æ¤œè¨¼ã®ã¿
   - BFFå±¤: ä¸­ç¶™ãƒ»èªè¨¼ãƒ»è»½å¾®ãªæ•´å½¢ã®ã¿
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸­æ ¸
   - ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤: ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯éä¾å­˜
   - ä¾å­˜æ–¹å‘ã¯å†…å‘ãï¼ˆUIâ†’BFFâ†’ã‚¢ãƒ—ãƒªâ†’ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰

2. **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ãŒé©åˆ‡ã«ã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹ã‹
   - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€é–¢æ•°
   - E2Eãƒ†ã‚¹ãƒˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒŠãƒªã‚ª
   - Acceptance Criteriaã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: è„†å¼±æ€§ãŒãªã„ã‹
   - XSSå¯¾ç­–ï¼ˆå…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰
   - CSRFå¯¾ç­–ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
   - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
   - èªè¨¼ãƒ»èªå¯ã®é©åˆ‡ãªå®Ÿè£…

4. **PRã‚µã‚¤ã‚º**: 10ãƒ•ã‚¡ã‚¤ãƒ«/500è¡Œä»¥å†…ã‹

5. **ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„**:
   - TypeScriptå‹å®šç¾©
   - ESLintæº–æ‹ 
   - é©åˆ‡ãªå‘½å

ã€å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‘
- CLAUDE.md: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡
- requirements/BRD.md: è¦ä»¶å®šç¾©

ã€å‡ºåŠ›å½¢å¼ã€‘
Markdownå½¢å¼ã§ä»¥ä¸‹ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
- âœ… è‰¯ã„ç‚¹ï¼ˆ3ã¤ä»¥ä¸Šï¼‰
- âš ï¸ æ”¹å–„ææ¡ˆï¼ˆã‚ã‚Œã°ï¼‰
- ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µï¼ˆã‚ã‚Œã°ï¼‰
- ğŸ“Š ç·åˆè©•ä¾¡: APPROVE / REQUEST_CHANGES

ãã‚Œã§ã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
EOF
)

# Claude Code CLIã‚’å®Ÿè¡Œ
echo "ğŸ¤– Claude Code CLIã‚’èµ·å‹•..."

if command -v claude-code &> /dev/null; then
    echo "$PROMPT" | claude-code --non-interactive \
        --context out/pr_diff.txt \
        --context CLAUDE.md \
        --context requirements/BRD.md \
        > out/review_result.md
else
    echo "âš ï¸  Claude Code CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"

    # é–‹ç™ºç”¨: ãƒ‡ãƒ¢ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ
    cat > out/review_result.md <<DEMO
# ğŸ¤– AI Code Review - PR #${PR_NUMBER}

## âœ… è‰¯ã„ç‚¹
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¢ƒç•ŒãŒé©åˆ‡ã«åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒååˆ†ã§ã™ï¼ˆæ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ã‚’ã‚«ãƒãƒ¼ï¼‰
- TypeScriptå‹å®šç¾©ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™

## âš ï¸ æ”¹å–„ææ¡ˆ
_ãªã—_

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µ
_ãªã—_

## ğŸ“Š ç·åˆè©•ä¾¡
**APPROVE** - CLAUDE.mdã®åŸå‰‡ã«æº–æ‹ ã—ã¦ãŠã‚Šã€ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚

---
ğŸ¤– Powered by Claude Code
DEMO

    echo "âœ… ãƒ‡ãƒ¢ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ"
fi

echo "âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸ"
cat out/review_result.md
